<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mantenimiento · Alineaciones (Firebase)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#131a22; --ink:#e6f0ff; --muted:#9fb6d1; --accent:#0ea5ff;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
  h1{font:600 20px/1.2 system-ui;margin:16px 16px 8px;color:var(--ink)}
  .bar{display:flex;gap:12px;align-items:center; padding:8px 16px; background:#0f141c; border-bottom:1px solid #1b2430}
  .bar input[type="text"], .bar input[type="number"], .bar select{background:#0b1118;border:1px solid #1b2636;border-radius:8px;padding:8px 10px;color:var(--ink);outline:none}
  .bar input[type="text"]{min-width:240px}
  .bar .pill{padding:6px 10px;border-radius:999px;background:#0b1118;border:1px solid #1b2636;color:var(--muted)}
  .main{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
  .card{background:var(--panel);border:1px solid #1c2735;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1b2430;font:700 16px/1.2 system-ui;color:var(--ink);display:flex;align-items:center;justify-content:space-between}
  .card .muted{color:var(--muted);font-weight:500}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #1b2430}
  th{font-weight:600;color:#bfe5ff;background:#0f161f;position:sticky;top:0;z-index:1}
  tbody tr:hover{background:#0f161f}
  .row-actions{display:flex;gap:8px}
  button{cursor:pointer;border:1px solid transparent;border-radius:10px;padding:8px 10px;background:#0b1118;color:var(--ink)}
  button.primary{background:linear-gradient(180deg,#18b0ff,#0ea5ff);border-color:#0891b2;color:white;font-weight:700}
  button.ghost{background:#0b1118;border-color:#1b2636;color:var(--muted)}
  button.danger{background:#1a0c0c;border-color:#3a1414;color:#ffd0d0}
  button.small{padding:6px 8px;border-radius:8px;font-size:12px}
  form.inline{display:flex;gap:10px;align-items:center;padding:10px;border-top:1px dashed #1b2430}
  form.inline input, form.inline select{background:#0b1118;border:1px solid #1b2636;border-radius:10px;padding:8px 10px;color:var(--ink);min-width:0}
  form.inline input[type="number"]{width:92px}
  .flex{display:flex;align-items:center;gap:10px}
  .right{margin-left:auto}
  .msg{margin:10px 16px;color:#a7f3d0;display:none}
  .sep{height:8px}
</style>
</head>
<body>
  <div class="bar">
    <strong>Alineaciones · Firebase</strong>
    <span class="pill">matchId:</span>
    <input id="matchId" type="text" placeholder="p.ej. test123" />
    <button class="primary" id="btnLoad">Cargar</button>
    <span class="right muted" id="conn">Firebase: —</span>
  </div>
  <h1>Equipos</h1>
  <div class="main">
    <!-- HOME -->
    <section class="card" id="homeCard">
      <h2>
        <span>HOME · <span class="muted" id="homeName">—</span></span>
        <span class="flex">
          <button class="ghost small" id="btnEditHomeName">Renombrar</button>
          <button class="danger small" id="btnResetHome">Reset equipo</button>
        </span>
      </h2>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Equipo</th><th>Nº</th><th>Jugador/a</th><th>Juega</th><th style="width:200px">Acciones</th></tr>
          </thead>
          <tbody id="homeBody"></tbody>
        </table>
      </div>
      <form class="inline" id="homeForm">
        <input type="number" id="homeNum" placeholder="Nº" min="0" max="999" required />
        <input type="text" id="homePlayer" placeholder="Nombre del/la jugador/a" required />
        <select id="homePlays">
          <option value="SÍ" selected>SÍ</option>
          <option value="NO">NO</option>
        </select>
        <button class="primary" type="submit">Añadir</button>
      </form>
      <div class="sep"></div>
    </section>

    <!-- AWAY -->
    <section class="card" id="awayCard">
      <h2>
        <span>AWAY · <span class="muted" id="awayName">—</span></span>
        <span class="flex">
          <button class="ghost small" id="btnEditAwayName">Renombrar</button>
          <button class="danger small" id="btnResetAway">Reset equipo</button>
        </span>
      </h2>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Equipo</th><th>Nº</th><th>Jugador/a</th><th>Juega</th><th style="width:200px">Acciones</th></tr>
          </thead>
          <tbody id="awayBody"></tbody>
        </table>
      </div>
      <form class="inline" id="awayForm">
        <input type="number" id="awayNum" placeholder="Nº" min="0" max="999" required />
        <input type="text" id="awayPlayer" placeholder="Nombre del/la jugador/a" required />
        <select id="awayPlays">
          <option value="SÍ" selected>SÍ</option>
          <option value="NO">NO</option>
        </select>
        <button class="primary" type="submit">Añadir</button>
      </form>
      <div class="sep"></div>
    </section>
  </div>

  <p class="msg" id="msg"></p>

  <!-- Firebase compat para coincidir con tus otras apps -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script>
  (function(){
    const qs=new URLSearchParams(location.search);
    const el={
      matchId:document.getElementById('matchId'), btnLoad:document.getElementById('btnLoad'), conn:document.getElementById('conn'),
      homeBody:document.getElementById('homeBody'), awayBody:document.getElementById('awayBody'),
      homeForm:document.getElementById('homeForm'), awayForm:document.getElementById('awayForm'),
      homeNum:document.getElementById('homeNum'), awayNum:document.getElementById('awayNum'),
      homePlayer:document.getElementById('homePlayer'), awayPlayer:document.getElementById('awayPlayer'),
      homePlays:document.getElementById('homePlays'), awayPlays:document.getElementById('awayPlays'),
      homeName:document.getElementById('homeName'), awayName:document.getElementById('awayName'),
      btnResetHome:document.getElementById('btnResetHome'), btnResetAway:document.getElementById('btnResetAway'),
      btnEditHomeName:document.getElementById('btnEditHomeName'), btnEditAwayName:document.getElementById('btnEditAwayName'),
      msg:document.getElementById('msg')
    };

    const cfg={
      apiKey:"AIzaSyA4gVcq3UerKAHcmarEPlvkVp-iS7jvDaQ",
      authDomain:"supervolei-panel-final.firebaseapp.com",
      databaseURL:"https://supervolei-panel-final-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"supervolei-panel-final",
      storageBucket:"supervolei-panel-final.firebasestorage.app",
      messagingSenderId:"993690944196",
      appId:"1:993690944196:web:1a7ea451c03201e6f6ff91"
    };
    firebase.initializeApp(cfg);
    el.conn.textContent='Firebase: conectando…';

    firebase.auth().signInAnonymously().then(()=>{
      el.conn.textContent='Firebase: conectado';
      init();
    }).catch(err=>{ el.conn.textContent='Firebase: error de autenticación'; console.error(err); });

    function init(){
      el.matchId.value = qs.get('matchId') || 'test123';
      el.btnLoad.addEventListener('click', load);
      el.matchId.addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });
      load();

      el.homeForm.addEventListener('submit', e=>{ e.preventDefault(); addPlayer('home'); });
      el.awayForm.addEventListener('submit', e=>{ e.preventDefault(); addPlayer('away'); });
      el.btnResetHome.addEventListener('click', ()=> resetTeam('home'));
      el.btnResetAway.addEventListener('click', ()=> resetTeam('away'));
      el.btnEditHomeName.addEventListener('click', ()=> editTeamName('home'));
      el.btnEditAwayName.addEventListener('click', ()=> editTeamName('away'));
    }

    let off={teams:null,home:null,away:null};
    function offAll(){ try{off.teams&&off.teams.off();}catch(_){} try{off.home&&off.home.off();}catch(_){} try{off.away&&off.away.off();}catch(_){} }

    function paths(){
      const id=(el.matchId.value||'').trim();
      return {
        base:`matches/${id}`,
        teams:`matches/${id}/teams`,
        lineupHome:`matches/${id}/lineups/home`,
        lineupAway:`matches/${id}/lineups/away`
      };
    }

    function load(){
      offAll();
      const p=paths();
      // Equipos (nombres)
      off.teams=firebase.database().ref(p.teams);
      off.teams.on('value', s=>{
        const v=s.val()||{}; el.homeName.textContent=v.home||'HOME'; el.awayName.textContent=v.away||'AWAY';
        renderTables();
      });
      // Alineaciones
      off.home=firebase.database().ref(p.lineupHome);
      off.away=firebase.database().ref(p.lineupAway);
      off.home.on('value', s=>{ state.home=s.val()||{}; renderTables(); });
      off.away.on('value', s=>{ state.away=s.val()||{}; renderTables(); });
      info(`Cargado matchId: ${el.matchId.value}`);
    }

    const state={ home:{}, away:{} };

    function renderTables(){
      const homeName=el.homeName.textContent||'HOME';
      const awayName=el.awayName.textContent||'AWAY';
      // map objects -> sorted arrays by number
      const mapToRows = (obj, teamName) => Object.entries(obj||{})
        .map(([key,val])=>({ key, num:Number(val?.number||val?.num||0), name:String(val?.name||'').trim(), team:teamName, plays:(String(val?.plays||'SÍ').toUpperCase()==='NO'?'NO':'SÍ') }))
        .sort((a,b)=>a.num-b.num);
      const H = mapToRows(state.home, homeName);
      const A = mapToRows(state.away, awayName);
      // render
      el.homeBody.innerHTML = H.map(r=>rowHTML(r,'home')).join('') || emptyRow(homeName);
      el.awayBody.innerHTML = A.map(r=>rowHTML(r,'away')).join('') || emptyRow(awayName);
      // bind actions
      for (const btn of document.querySelectorAll('[data-del]')){
        btn.addEventListener('click', ()=> delPlayer(btn.dataset.team, btn.dataset.key));
      }
      for (const btn of document.querySelectorAll('[data-edit]')){
        btn.addEventListener('click', ()=> editPlayer(btn.dataset.team, btn.dataset.key));
      }
    }

    function rowHTML(r, side){
      return `<tr id="row-${side}-${r.key}">
        <td>${esc(r.team)}</td>
        <td>${esc(r.num)}</td>
        <td>${esc(r.name)}</td>
        <td>${esc(r.plays)}</td>
        <td class="row-actions">
          <button class="ghost small" data-edit data-team="${side}" data-key="${r.key}">Editar</button>
          <button class="ghost small" data-del data-team="${side}" data-key="${r.key}">Eliminar</button>
        </td>
      </tr>`;
    }
    function emptyRow(team){
      return `<tr><td colspan="5" class="muted">(Sin jugadores en ${esc(team)})</td></tr>`;
    }

    function addPlayer(side){
      const teamName = side==='home' ? el.homeName.textContent : el.awayName.textContent;
      const numEl = side==='home' ? el.homeNum : el.awayNum;
      const nameEl = side==='home' ? el.homePlayer : el.awayPlayer;
      const playsEl = side==='home' ? el.homePlays : el.awayPlays;
      const num = Number(numEl.value||0);
      const name = (nameEl.value||'').trim();
      const plays = (playsEl.value||'SÍ').toUpperCase()==='NO'?'NO':'SÍ';
      if (!name){ return alert('Introduce el nombre del/la jugador/a'); }
      if (!Number.isFinite(num)){ return alert('Introduce un número válido'); }
      const ref = firebase.database().ref( side==='home' ? paths().lineupHome : paths().lineupAway );
      // guardamos con push ID; estructura normalizada
      const data = { number: num, name, plays };
      ref.push(data).then(()=>{
        numEl.value=''; nameEl.value=''; playsEl.value='SÍ'; info(`Añadido ${name} (#${num}) a ${teamName}`);
      }).catch(err=>alert('Error al guardar: '+err?.message));
    }

    function delPlayer(side, key){
      if (!key) return;
      const teamName = side==='home' ? el.homeName.textContent : el.awayName.textContent;
      if (!confirm(`¿Eliminar jugador/a de ${teamName}?`)) return;
      const ref = firebase.database().ref( side==='home' ? `${paths().lineupHome}/${key}` : `${paths().lineupAway}/${key}` );
      ref.remove().then(()=> info('Eliminado correctamente')).catch(err=>alert('Error al eliminar: '+err?.message));
    }

    function editPlayer(side, key){
      const row = document.getElementById(`row-${side}-${key}`);
      if (!row) return;
      const cells = row.querySelectorAll('td');
      const teamName = cells[0].textContent;
      const num = cells[1].textContent.trim();
      const name = cells[2].textContent.trim();
      const plays = cells[3].textContent.trim().toUpperCase()==='NO'?'NO':'SÍ';
      row.innerHTML = `
        <td>${esc(teamName)}</td>
        <td><input type="number" value="${esc(num)}" style="width:80px" /></td>
        <td><input type="text" value="${esc(name)}" style="width:220px" /></td>
        <td>
          <select>
            <option value="SÍ" ${plays==='SÍ'?'selected':''}>SÍ</option>
            <option value="NO" ${plays==='NO'?'selected':''}>NO</option>
          </select>
        </td>
        <td class="row-actions">
          <button class="primary small" data-save data-team="${side}" data-key="${key}">Guardar</button>
          <button class="ghost small" data-cancel data-team="${side}" data-key="${key}">Cancelar</button>
        </td>`;
      row.querySelector('[data-save]').addEventListener('click', ()=> savePlayer(side,key));
      row.querySelector('[data-cancel]').addEventListener('click', renderTables);
    }

    function savePlayer(side, key){
      const row = document.getElementById(`row-${side}-${key}`);
      if (!row) return;
      const inputs = row.querySelectorAll('input,select');
      const num = Number(inputs[0].value||0);
      const name = (inputs[1].value||'').trim();
      const plays = (inputs[2].value||'SÍ').toUpperCase()==='NO'?'NO':'SÍ';
      if (!name){ return alert('Introduce el nombre del/la jugador/a'); }
      if (!Number.isFinite(num)){ return alert('Introduce un número válido'); }
      const refBase = side==='home' ? paths().lineupHome : paths().lineupAway;
      firebase.database().ref(`${refBase}/${key}`).update({ number:num, name, plays })
        .then(()=> info('Jugador/a actualizado'))
        .catch(err=> alert('Error al actualizar: '+err?.message));
    }

    function resetTeam(side){
      const teamName = side==='home' ? el.homeName.textContent : el.awayName.textContent;
      if (!confirm(`⚠️ Esto eliminará TODA la alineación de ${teamName}. ¿Seguro?`)) return;
      const ref = firebase.database().ref( side==='home' ? paths().lineupHome : paths().lineupAway );
      ref.remove().then(()=> info(`Reseteada alineación de ${teamName}`)).catch(err=>alert('Error al resetear: '+err?.message));
    }

    function editTeamName(side){
      const curr = side==='home' ? el.homeName.textContent : el.awayName.textContent;
      const next = prompt('Nuevo nombre de equipo:', curr||'');
      if (next===null) return;
      const clean=(next||'').trim(); if(!clean) return alert('Nombre vacío.');
      const ref = firebase.database().ref(paths().teams + (side==='home'?'/home':'/away'));
      ref.set(clean).then(()=> info('Equipo renombrado')).catch(err=>alert('Error al renombrar: '+err?.message));
    }

    function esc(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function info(t){ el.msg.textContent=t; el.msg.style.display='block'; setTimeout(()=>{el.msg.style.display='none'}, 1800); }
  })();
  </script>
</body>
</html>