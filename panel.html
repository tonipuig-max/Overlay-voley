<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Panel Marcador Vóley — Autosets (autoconnect + auto-next-set + placeholders)</title>
<style>
  :root{
    --bg:#ffffff; --card:#f7f8fa; --muted:#e3e7ee; --text:#1f2937; --sub:#6b7280;
    --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --radius:14px;
    --input:#ffffff; --input-border:#d1d5db; --btn:#eef2f7; --btn-border:#cbd5e1;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px 16px 120px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:var(--radius);padding:14px;margin-bottom:14px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px;color:var(--sub)}
  label{font-size:13px;color:var(--sub)}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input);color:var(--text)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:10px}
  .grid2{grid-template-columns:1fr 1fr}

  .btn{appearance:none;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px;
       width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--btn-border);
       background:var(--btn);color:var(--text);font-weight:700;font-size:16px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-ok{ background:#e9f7ee; border-color:#bfe8ca; color:#0f5132 }
  .btn-accent{ background:#e8efff; border-color:#c7d5e1; color:#1e40af }

  /* Inputs de marcador: más anchos y con altura/line-height para no cortar dos dígitos */
  .scoreInput{
    width:72px; min-width:72px;
    text-align:center;font-size:28px;font-weight:900;
    padding:8px 10px;border-radius:10px;background:#fff;border:1px solid var(--input-border);color:var(--text);
    line-height:1.2; height:46px;
  }

  table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}
  th,td{padding:8px}
  th{color:var(--sub);font-weight:700;border-bottom:1px solid var(--muted);text-align:center}

  /* Distribución estándar en TODAS las celdas de contadores */
  .cell{display:grid; grid-template-columns: 56px minmax(60px, auto) 56px; align-items:center; justify-items:center; gap:10px}
  .cell .btn{ width:auto; min-width:56px }
  .cell .scoreInput{ width:72px; min-width:72px }

  /* Compact móvil */
  @media (max-width:420px){
    .cell{ grid-template-columns: 50px minmax(58px, auto) 50px; gap:8px }
    .cell .btn{ min-width:50px; padding:6px 6px; font-size:13px }
    .cell .scoreInput{ width:66px; min-width:66px; font-size:22px; height:42px; padding:6px 6px }
    th,td{ padding-left:6px; padding-right:6px }
  }

  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
  .dot.ok{background:var(--ok)}
  .small{font-size:12px;color:var(--sub)}
  .teamHeader{ font-weight:800; font-size:14px; margin:4px 0 8px; color:var(--text); text-align:center; }

  .setline{ display:flex; align-items:center; justify-content:center; gap:12px; }
  .setBtn{ width:auto; min-width:56px; }
  .setNum{ width:auto; min-width:82px; text-align:center; font-size:40px; line-height:1; font-weight:900; padding:8px 14px; border-radius:12px; background:#fff; border:1px solid var(--input-border); }

  .footer{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;background:linear-gradient(to top, rgba(255,255,255,.95), rgba(255,255,255,.7), transparent);border-top:1px solid var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <!-- 1) Nombres equipos -->
  <div class="card">
    <div class="grid grid2">
      <div><label>Equipo HOME</label><input id="nameHome" /></div>
      <div><label>Equipo AWAY</label><input id="nameAway" /></div>
    </div>
    <div class="small" style="margin-top:8px">Validar con Enter o salir del campo para guardar.</div>
  </div>

  <!-- 2) Marcador (2 columnas, sin columna Set) -->
  <div class="card">
    <h2>Puntos por set</h2>
    <table>
      <thead>
        <tr>
          <th id="thHome">HOME</th>
          <th id="thAway">AWAY</th>
        </tr>
      </thead>
      <tbody id="pointsBody"></tbody>
    </table>
  </div>

  <!-- 2b) Sets ganados (autocálculo + manual) -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <h2 style="margin:0">Sets ganados</h2>
      <label class="small" style="display:flex;align-items:center;gap:8px">
        <input id="autoSetsToggle" type="checkbox" checked>
        Auto‑calcular
      </label>
    </div>
    <div class="grid grid2" style="margin-top:8px">
      <div>
        <div class="teamHeader" id="setsWonHomeName">HOME</div>
        <div class="cell">
          <button class="btn" onclick="bumpSetsWon('home',-1)">−</button>
          <input id="setsWon_home" class="scoreInput" type="number" value="0">
          <button class="btn btn-ok" onclick="bumpSetsWon('home',1)">+</button>
        </div>
      </div>
      <div>
        <div class="teamHeader" id="setsWonAwayName">AWAY</div>
        <div class="cell">
          <button class="btn" onclick="bumpSetsWon('away',-1)">−</button>
          <input id="setsWon_away" class="scoreInput" type="number" value="0">
          <button class="btn btn-ok" onclick="bumpSetsWon('away',1)">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) Heatmap (2 columnas, sin columna Zona; placeholders Z1..Z3 visibles) -->
  <div class="card">
    <h2>Heatmap (por set)</h2>
    <div class="setline" style="margin-bottom:8px">
      <button class="btn setBtn" onclick="heatSetChange(-1)">−</button>
      <input id="heatSet" class="setNum" value="1" readonly />
      <button class="btn btn-ok setBtn" onclick="heatSetChange(1)">+</button>
    </div>
    <table style="margin-top:6px">
      <thead><tr><th id="heatHeadHome">HOME</th><th id="heatHeadAway">AWAY</th></tr></thead>
      <tbody id="heatBody"></tbody>
    </table>
  </div>

  <!-- 4) Errores de saque -->
  <div class="card">
    <h2>Errores de saque por set</h2>
    <div class="setline" style="margin-bottom:8px">
      <button class="btn setBtn" onclick="serveErrSetChange(-1)">−</button>
      <input id="serveErrSet" class="setNum" value="1" readonly />
      <button class="btn btn-ok setBtn" onclick="serveErrSetChange(1)">+</button>
    </div>
    <div class="grid grid2">
      <div>
        <div class="teamHeader" id="serveErrHomeName">HOME</div>
        <div class="cell">
          <button class="btn" onclick="bumpServeErr('home',-1)">−</button>
          <input id="serveErr_home" class="scoreInput" value="0">
          <button class="btn btn-ok" onclick="bumpServeErr('home',1)">+</button>
        </div>
      </div>
      <div>
        <div class="teamHeader" id="serveErrAwayName">AWAY</div>
        <div class="cell">
          <button class="btn" onclick="bumpServeErr('away',-1)">−</button>
          <input id="serveErr_away" class="scoreInput" value="0">
          <button class="btn btn-ok" onclick="bumpServeErr('away',1)">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 5) Puntos de saque (aces) -->
  <div class="card">
    <h2>Puntos de saque (aces) por set</h2>
    <div class="setline" style="margin-bottom:8px">
      <button class="btn setBtn" onclick="servePtsSetChange(-1)">−</button>
      <input id="servePtsSet" class="setNum" value="1" readonly />
      <button class="btn btn-ok setBtn" onclick="servePtsSetChange(1)">+</button>
    </div>
    <div class="grid grid2">
      <div>
        <div class="teamHeader" id="servePtsHomeName">HOME</div>
        <div class="cell">
          <button class="btn" onclick="bumpServePts('home',-1)">−</button>
          <input id="servePts_home" class="scoreInput" value="0">
          <button class="btn btn-ok" onclick="bumpServePts('home',1)">+</button>
        </div>
      </div>
      <div>
        <div class="teamHeader" id="servePtsAwayName">AWAY</div>
        <div class="cell">
          <button class="btn" onclick="bumpServePts('away',-1)">−</button>
          <input id="servePts_away" class="scoreInput" value="0">
          <button class="btn btn-ok" onclick="bumpServePts('away',1)">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 6) Conexión -->
  <div class="card">
    <h1>Conexión</h1>
    <div class="grid grid2">
      <div><label>matchId</label><input id="matchId" placeholder="test123" value="test123"></div>
      <div class="row">
        <button class="btn btn-accent" id="btnConnect">Conectar</button>
        <button class="btn" id="btnReset">Reset 0-0</button>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  <div class="status">
    <div id="netdot" class="dot"></div>
    <div id="netmsg" class="small">Desconectado</div>
    <div class="small" id="lastSync"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getDatabase, ref, onValue, set, update, get, child } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA4gVcq3UerKAHcmarEPlvkVp-iS7jvDaQ",
    authDomain: "supervolei-panel-final.firebaseapp.com",
    databaseURL: "https://supervolei-panel-final-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "supervolei-panel-final",
    storageBucket: "supervolei-panel-final.firebasestorage.app",
    messagingSenderId: "993690944196",
    appId: "1:993690944196:web:1a7ea451c03201e6f6ff91"
  };
  let db=null, matchPath=null, listenersBound=false;
// Mapear filas de AWAY a índices de heatmap: 1↔3, 2→2
  const mapAwayIdx = (z) => (z===1 ? 2 : z===3 ? 0 : 1);

  const $ = (s)=>document.querySelector(s);
  const net = (ok,msg)=>{ $('#netdot').classList.toggle('ok', !!ok); $('#netmsg').textContent = msg || (ok?'Conectado':'Desconectado'); if(ok) $('#lastSync').textContent='Actualizado · '+new Date().toLocaleTimeString(); };
  function clamp0(n){ n=parseInt(n||0,10); return isNaN(n)?0:Math.max(0,n); }

  const writeMark = new Map();
  const mark=(p)=>writeMark.set(p,Date.now());
  const isOwn=(p,ms=800)=>{ const t=writeMark.get(p); return t && (Date.now()-t)<ms; };

  // Track de sets decididos para avanzar una sola vez
  const decided = new Map(); // key=setNo, value=boolean

  function paintScoreTable(){
    const body = $('#pointsBody'); body.innerHTML='';
    for(let i=1;i<=5;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="cell">
            <button class="btn" onclick="window.bumpScore(${i},'home',-1)">−</button>
            <input class="scoreInput" id="in_home_${i}" type="number" value="0">
            <button class="btn btn-ok" onclick="window.bumpScore(${i},'home',+1)">+</button>
          </div>
        </td>
        <td>
          <div class="cell">
            <button class="btn" onclick="window.bumpScore(${i},'away',-1)">−</button>
            <input class="scoreInput" id="in_away_${i}" type="number" value="0">
            <button class="btn btn-ok" onclick="window.bumpScore(${i},'away',+1)">+</button>
          </div>
        </td>`;
      body.appendChild(tr);
      const ih = $('#in_home_'+i), ia = $('#in_away_'+i);
      ih.addEventListener('change', ()=>manualScore(i,'home', ih.value));
      ia.addEventListener('change', ()=>manualScore(i,'away', ia.value));
      ih.addEventListener('keydown', e=>{ if(e.key==='Enter'){ ih.blur(); }});
      ia.addEventListener('keydown', e=>{ if(e.key==='Enter'){ ia.blur(); }});
    }
  }

  function paintHeatTable(){
    const body = $('#heatBody'); body.innerHTML='';
    for(let z=1; z<=3; z++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><div class="cell"><button class="btn" onclick="window.bumpHeat('home',${z},-1)">−</button><input class="scoreInput" id="heat_home_${z}" placeholder="Z${z}" type="number" value=""><button class="btn btn-ok" onclick="window.bumpHeat('home',${z},+1)">+</button></div></td>
        <td><div class="cell"><button class="btn" onclick="window.bumpHeat('away',${z},-1)">−</button><input class="scoreInput" id="heat_away_${z}" placeholder="Z${z}" type="number" value=""><button class="btn btn-ok" onclick="window.bumpHeat('away',${z},+1)">+</button></div></td>`;
      body.appendChild(tr);
      const ih = $('#heat_home_'+z), ia = $('#heat_away_'+z);
      ih.addEventListener('change', ()=>manualHeat('home',z, ih.value));
      ia.addEventListener('change', ()=>manualHeat('away',z, ia.value));
    }
  }

  function setTeamHeaders(home, away){
    const H = home || 'HOME', A = away || 'AWAY';
    document.getElementById('thHome').textContent = H;
    document.getElementById('thAway').textContent = A;
    document.getElementById('heatHeadHome').textContent = H;
    document.getElementById('heatHeadAway').textContent = A;
    document.getElementById('serveErrHomeName').textContent = H;
    document.getElementById('serveErrAwayName').textContent = A;
    document.getElementById('servePtsHomeName').textContent = H;
    document.getElementById('servePtsAwayName').textContent = A;
    document.getElementById('setsWonHomeName').textContent = H;
    document.getElementById('setsWonAwayName').textContent = A;
  }

  function updateHeadersFromInputs(){
    const h = $('#nameHome').value.trim();
    const a = $('#nameAway').value.trim();
    setTeamHeaders(h, a);
  }

  async function connect(){
    try{ initializeApp(firebaseConfig); }catch(e){}
    try{
      const auth = getAuth(); db = getDatabase();
      await signInAnonymously(auth);
      const id = $('#matchId').value.trim() || 'test123';
      matchPath = 'matches/'+id;
      net(true,'Conectado');
      await ensureStructure();
      if(!listenersBound){ bindListeners(); listenersBound=true; }
      paintScoreTable(); paintHeatTable();
      updateHeadersFromInputs();
    }catch(err){
      console.error(err);
      net(false,'Error al conectar');
      alert('No se pudo conectar a Firebase. Revisa la configuración y vuelve a intentar con el botón Conectar.');
      throw err;
    }
  }

  async function ensureStructure(){
    const rootRef = ref(db, matchPath);
    const snap = await get(rootRef);
    if(!snap.exists()){
      const base = { teams:{home:'HOME', away:'AWAY'}, sets:{}, heat:{ setNumber:1, sets:{} }, serveErrors:{}, servePoints:{}, setsWon:{home:0,away:0} };
      for(let i=1;i<=5;i++){ base.sets[i]={home:0,away:0}; decided.set(i,false); }
      for(let s=1;s<=5;s++){ base.heat.sets[s]={home:[0,0,0], away:[0,0,0]}; base.serveErrors[s]={home:0,away:0}; base.servePoints[s]={home:0,away:0}; }
      await set(rootRef, base);
    }else{
      for(let i=1;i<=5;i++){ decided.set(i,false); }
      const setsWonSnap = await get(child(ref(db), matchPath+'/setsWon'));
      if(!setsWonSnap.exists()) await update(rootRef, { setsWon:{home:0,away:0} });
    }
  }

  function bindListeners(){
    onValue(ref(db, matchPath+'/teams'), (s)=>{
      const v = s.val() || {};
      if(document.activeElement !== $('#nameHome')) $('#nameHome').value = v.home || '';
      if(document.activeElement !== $('#nameAway')) $('#nameAway').value = v.away || '';
      setTeamHeaders(v.home, v.away);
    });

    // Puntos por set
    for(let i=1;i<=5;i++){
      onValue(ref(db, matchPath+'/sets/'+i+'/home'), (s)=>{
        const path = '/sets/'+i+'/home'; if(isOwn(path)) return;
        const val = clamp0(s.val()); const el = $('#in_home_'+i); if(el && document.activeElement!==el) el.value=val;
        maybeAutoCalcSetsWon();
      });
      onValue(ref(db, matchPath+'/sets/'+i+'/away'), (s)=>{
        const path = '/sets/'+i+'/away'; if(isOwn(path)) return;
        const val = clamp0(s.val()); const el = $('#in_away_'+i); if(el && document.activeElement!==el) el.value=val;
        maybeAutoCalcSetsWon();
      });
    }

    // Heat + saques
    onValue(ref(db, matchPath+'/heat/setNumber'), (s)=>{
      const path='/heat/setNumber'; if(isOwn(path)) return;
      const n = clamp0(s.val()) || 1;
      $('#heatSet').value = n; $('#serveErrSet').value = n; $('#servePtsSet').value = n;
      refreshHeatRow(n); refreshServeErr(n); refreshServePts(n);
    });
    onValue(ref(db, matchPath+'/heat/sets'), (s)=>{
      const all = s.val() || {};
      const n = clamp0($('#heatSet').value) || 1;
      const H = all[n] || {home:[0,0,0], away:[0,0,0]};
      for(let z=1; z<=3; z++){
        const eh = $('#heat_home_'+z), ea = $('#heat_away_'+z);
        if(eh && document.activeElement!==eh) eh.value = clamp0(H.home?.[z-1] ?? 0);
        if(ea && document.activeElement!==ea) ea.value = clamp0(H.away?.[ mapAwayIdx(z) ] ?? 0);
      }
    });
    onValue(ref(db, matchPath+'/serveErrors'), (s)=>{
      const all = s.val() || {}; const n = clamp0($('#serveErrSet').value)||1;
      const v = all[n] || {home:0,away:0};
      const eh = $('#serveErr_home'), ea = $('#serveErr_away');
      if(eh && document.activeElement!==eh) eh.value = clamp0(v.home);
      if(ea && document.activeElement!==ea) ea.value = clamp0(v.away);
    });
    onValue(ref(db, matchPath+'/servePoints'), (s)=>{
      const all = s.val() || {}; const n = clamp0($('#servePtsSet').value)||1;
      const v = all[n] || {home:0,away:0};
      const eh = $('#servePts_home'), ea = $('#servePts_away');
      if(eh && document.activeElement!==eh) eh.value = clamp0(v.home);
      if(ea && document.activeElement!==ea) ea.value = clamp0(v.away);
    });

    // Sets ganados
    onValue(ref(db, matchPath+'/setsWon'), (s)=>{
      const v = s.val() || {home:0,away:0};
      const eh = $('#setsWon_home'), ea = $('#setsWon_away');
      if($('#autoSetsToggle').checked){
        if(eh && document.activeElement!==eh) eh.value = clamp0(v.home);
        if(ea && document.activeElement!==ea) ea.value = clamp0(v.away);
      }else{
        if(document.activeElement!==eh) eh.value = clamp0(v.home);
        if(document.activeElement!==ea) ea.value = clamp0(v.away);
      }
    });

    // Live headers
    $('#nameHome').addEventListener('input', updateHeadersFromInputs);
    $('#nameAway').addEventListener('input', updateHeadersFromInputs);

    // Guardar nombres
    const saveTeamNames = ()=>{
      const home = $('#nameHome').value.trim();
      const away = $('#nameAway').value.trim();
      if(!db||!matchPath) { setTeamHeaders(home, away); return; }
      update(ref(db, matchPath+'/teams'), { home, away }).catch(console.error);
    };
    $('#nameHome').addEventListener('blur', saveTeamNames);
    $('#nameAway').addEventListener('blur', saveTeamNames);
    $('#nameHome').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
    $('#nameAway').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); e.target.blur(); }});
  }

  // ====== Escrituras ======
  window.bumpScore = (setNo, side, delta)=>{
    const id = (side==='home'?'in_home_':'in_away_')+setNo;
    const el = $('#'+id); const next = Math.max(0, clamp0(el.value)+delta); el.value = next;
    const path = '/sets/'+setNo+'/'+side; mark(path);
    update(ref(db, matchPath+'/sets/'+setNo), { [side]: clamp0(el.value) }).catch(console.error);
    maybeAutoCalcSetsWon();
  };
  function manualScore(setNo, side, raw){
    const v = clamp0(raw); const path='/sets/'+setNo+'/'+side; mark(path);
    update(ref(db, matchPath+'/sets/'+setNo), { [side]: v }).catch(console.error);
    maybeAutoCalcSetsWon();
  }

  // Sets ganados manual
  window.bumpSetsWon = (side, delta)=>{
    const id = 'setsWon_'+side; const el = $('#'+id);
    const next = Math.max(0, clamp0(el.value) + delta); el.value = next;
    writeSetsWonToDB();
  };
  $('#setsWon_home').addEventListener('change', writeSetsWonToDB);
  $('#setsWon_away').addEventListener('change', writeSetsWonToDB);
  function writeSetsWonToDB(){
    const v = { home: clamp0($('#setsWon_home').value), away: clamp0($('#setsWon_away').value) };
    mark('/setsWon/home'); mark('/setsWon/away');
    update(ref(db, matchPath+'/setsWon'), v).catch(console.error);
  }

  // Toggle autocálculo
  $('#autoSetsToggle').addEventListener('change', ()=>{
    const on = $('#autoSetsToggle').checked;
    $('#setsWon_home').readOnly = on;
    $('#setsWon_away').readOnly = on;
    if(on) maybeAutoCalcSetsWon(true);
  });
  $('#setsWon_home').readOnly = true;
  $('#setsWon_away').readOnly = true;

  // ====== LÓGICA AUTOCÁLCULO ======
  function setIsDecided(setNo, h, a){
    const target = (setNo<=4)?25:15;
    return ((h>=target || a>=target) && Math.abs(h-a)>=2);
  }

  function computeSetsWonFromPoints(){
    let home=0, away=0;
    for(let s=1; s<=5; s++){
      const h = clamp0($('#in_home_'+s)?.value);
      const a = clamp0($('#in_away_'+s)?.value);
      if(setIsDecided(s,h,a)){
        if(h>a) home++; else if(a>h) away++;
      }
    }
    return {home, away};
  }

  function maybeAutoCalcSetsWon(force=false){
    if(!$('#autoSetsToggle').checked && !force) return;
    // 1) Autocálculo sets ganados
    const calc = computeSetsWonFromPoints();
    const inpH = $('#setsWon_home'), inpA = $('#setsWon_away');
    const curH = clamp0(inpH.value), curA = clamp0(inpA.value);
    if(calc.home!==curH) inpH.value = calc.home;
    if(calc.away!==curA) inpA.value = calc.away;
    mark('/setsWon/home'); mark('/setsWon/away');
    update(ref(db, matchPath+'/setsWon'), calc).catch(console.error);

    // 2) Detección de cierre de set y avance de setNumber (una sola vez)
    let advanced = false;
    for(let s=1; s<=5; s++){
      const h = clamp0($('#in_home_'+s)?.value);
      const a = clamp0($('#in_away_'+s)?.value);
      const dec = setIsDecided(s,h,a);
      const prev = decided.get(s) || false;
      decided.set(s, dec);
      if(dec && !prev && !advanced){
        const nextSet = Math.min(s+1,5);
        const path='/heat/setNumber'; mark(path);
        set(ref(db, matchPath+path), nextSet);
        // Refleja en UI inmediatamente
        $('#heatSet').value = nextSet; $('#serveErrSet').value = nextSet; $('#servePtsSet').value = nextSet;
        advanced = true; // solo una vez por invocación
      }
    }
  }

  // Heat / serve sections
  function heatSetChange(d){
    const cur = clamp0($('#heatSet').value)||1;
    const next = Math.max(1, Math.min(5, cur + d));
    if(next===cur) return;
    $('#heatSet').value = next; $('#serveErrSet').value = next; $('#servePtsSet').value = next;
    const path='/heat/setNumber'; mark(path);
    set(ref(db, matchPath+path), next);
    refreshHeatRow(next); refreshServeErr(next); refreshServePts(next);
  }
  window.heatSetChange = heatSetChange;

  function refreshHeatRow(n){
    get(child(ref(db), matchPath+'/heat/sets/'+n)).then(s=>{
      const v = s.val() || {home:[0,0,0], away:[0,0,0]};
      for(let z=1; z<=3; z++){
        const eh = $('#heat_home_'+z), ea = $('#heat_away_'+z);
        if(eh && document.activeElement!==eh) eh.value = clamp0(v.home?.[z-1] ?? 0);
        if(ea && document.activeElement!==ea) ea.value = clamp0(v.away?.[z-1] ?? 0);
      }
    });
  }

  window.bumpHeat = (side, zone, delta)=>{
  const id = `heat_${side}_${zone}`;
  const el = $('#'+id);
  const next = Math.max(0, clamp0(el.value)+delta);
  el.value = next;

  const idx = (side === 'away') ? mapAwayIdx(zone) : (zone - 1);   // <- cambio
  const path = '/heat/sets/'+($('#heatSet').value||1)+'/'+side+'/'+idx;
  mark(path);
  set(ref(db, matchPath+path), next).catch(console.error);
};

function manualHeat(side, zone, raw){
  const v = clamp0(raw);
  const idx = (side === 'away') ? mapAwayIdx(zone) : (zone - 1);   // <- cambio
  const path = '/heat/sets/'+($('#heatSet').value||1)+'/'+side+'/'+idx;
  mark(path);
  set(ref(db, matchPath+path), v).catch(console.error);
}


  function serveErrSetChange(d){
    const cur = clamp0($('#serveErrSet').value)||1;
    const next = Math.max(1, Math.min(5, cur + d));
    if(next===cur) return;
    $('#serveErrSet').value = next; refreshServeErr(next);
    const path='/heat/setNumber'; mark(path);
    set(ref(db, matchPath+path), next);
  }
  window.serveErrSetChange = serveErrSetChange;
  function refreshServeErr(n){
    get(child(ref(db), matchPath+'/serveErrors/'+n)).then(s=>{
      const v = s.val() || {home:0,away:0};
      const eh = $('#serveErr_home'), ea = $('#serveErr_away');
      if(eh && document.activeElement!==eh) eh.value = clamp0(v.home);
      if(ea && document.activeElement!==ea) ea.value = clamp0(v.away);
    });
  }
  window.bumpServeErr = (side, delta)=>{
    const id = 'serveErr_'+side; const el = $('#'+id);
    const next = Math.max(0, clamp0(el.value)+delta); el.value = next;
    const setNo = clamp0($('#serveErrSet').value)||1;
    const path = '/serveErrors/'+setNo+'/'+side; mark(path);
    set(ref(db, matchPath+path), next).catch(console.error);
  };
  $('#serveErr_home').addEventListener('change', ()=>{
    const v = clamp0($('#serveErr_home').value); const setNo=clamp0($('#serveErrSet').value)||1;
    const path='/serveErrors/'+setNo+'/home'; mark(path); set(ref(db, matchPath+path), v);
  });
  $('#serveErr_away').addEventListener('change', ()=>{
    const v = clamp0($('#serveErr_away').value); const setNo=clamp0($('#serveErrSet').value)||1;
    const path='/serveErrors/'+setNo+'/away'; mark(path); set(ref(db, matchPath+path), v);
  });

  function servePtsSetChange(d){
    const cur = clamp0($('#servePtsSet').value)||1;
    const next = Math.max(1, Math.min(5, cur + d));
    if(next===cur) return;
    $('#servePtsSet').value = next; refreshServePts(next);
    const path='/heat/setNumber'; mark(path);
    set(ref(db, matchPath+path), next);
  }
  window.servePtsSetChange = servePtsSetChange;
  function refreshServePts(n){
    get(child(ref(db), matchPath+'/servePoints/'+n)).then(s=>{
      const v = s.val() || {home:0,away:0};
      const eh = $('#servePts_home'), ea = $('#servePts_away');
      if(eh && document.activeElement!==eh) eh.value = clamp0(v.home);
      if(ea && document.activeElement!==ea) ea.value = clamp0(v.away);
    });
  }
  window.bumpServePts = (side, delta)=>{
    const id = 'servePts_'+side; const el = $('#'+id);
    const next = Math.max(0, clamp0(el.value)+delta); el.value = next;
    const setNo = clamp0($('#servePtsSet').value)||1;
    const path = '/servePoints/'+setNo+'/'+side; mark(path);
    set(ref(db, matchPath+path), next).catch(console.error);
  };
  $('#servePts_home').addEventListener('change', ()=>{
    const v = clamp0($('#servePts_home').value); const setNo=clamp0($('#servePtsSet').value)||1;
    const path='/servePoints/'+setNo+'/home'; mark(path); set(ref(db, matchPath+path), v);
  });
  $('#servePts_away').addEventListener('change', ()=>{
    const v = clamp0($('#servePts_away').value); const setNo=clamp0($('#servePtsSet').value)||1;
    const path='/servePoints/'+setNo+'/away'; mark(path); set(ref(db, matchPath+path), v);
  });

  document.getElementById('btnConnect').addEventListener('click', connect);
  document.getElementById('btnReset').addEventListener('click', async ()=>{
    if(!db||!matchPath) return alert('Conecta primero.');
    if(!confirm('¿Resetear a 0-0 todo (incluye sets ganados)?')) return;
    await set(ref(db, matchPath), null);
    const rootRef = ref(db, matchPath);
    const base = {teams:{home:'HOME',away:'AWAY'}, sets:{}, heat:{setNumber:1,sets:{}}, serveErrors:{}, servePoints:{}, setsWon:{home:0,away:0}};
    for(let i=1;i<=5;i++){ base.sets[i]={home:0,away:0}; decided.set(i,false); }
    for(let s=1;s<=5;s++){ base.heat.sets[s]={home:[0,0,0],away:[0,0,0]}; base.serveErrors[s]={home:0,away:0}; base.servePoints[s]={home:0,away:0}; }
    await set(rootRef, base);
  });

  // ===== Autoconexión al cargar =====
  window.addEventListener('DOMContentLoaded', ()=>{
    connect().catch(()=>{/* el alert ya se mostró en connect() */});
  });

  // Inicial (por si el usuario teclea antes de conectar)
  paintScoreTable(); paintHeatTable();
  updateHeadersFromInputs();
</script>

</body>
</html>
