<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OBS 路 Racha 路 Equipo (auto-rebind por set)</title>
<style>
  html,body{margin:0;padding:0;background:transparent}
  :root{
    --scale:18;
    --fg:#ffffff;
    --shadow:rgba(0,0,0,.75);
    --pill:rgba(0,0,0,.45);
    --pill-bd:rgba(255,255,255,.5);
    --radius:14px;
    --home:#a3551e;
    --away:#0b63b6;
  }
  .wrap{display:inline-flex;flex-direction:row;align-items:center;gap:10px;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
        color:var(--fg);text-shadow:0 2px 4px var(--shadow);}
  .title{flex:0 0 auto; white-space:nowrap;
         font-weight:900;letter-spacing:.8px;
         font-size:calc(var(--scale)*1.4px);
         background:var(--pill);border:1px solid var(--pill-bd);border-radius:var(--radius);
         padding:6px 14px}
  .home .title{ background:color-mix(in oklab, var(--home) 70%, transparent); border-color: color-mix(in oklab, #fff 50%, var(--home) 25%) }
  .away .title{ background:color-mix(in oklab, var(--away) 70%, transparent); border-color: color-mix(in oklab, #fff 50%, var(--away) 25%) }
  .balls{flex:1 1 auto;display:flex;gap:6px;align-items:center;justify-content:flex-start}
  .ball{font-size:calc(var(--scale)*1.9px);line-height:1;display:block;filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}
  .hidden{display:none !important}

/* === Fallback OBS (sin color-mix) === */
.title{
  background: rgba(0,0,0,.45);
  border: 1px solid rgba(255,255,255,.5);
}
.home .title{
  background: #a3551e;
  border-color: rgba(255,255,255,.6);
  /* Navegadores modernos usar谩n esta l铆nea (OBS la ignora) */
  background: color-mix(in srgb, var(--home) 85%, white);
}
.away .title{
  background: #0b63b6;
  border-color: rgba(255,255,255,.6);
  background: color-mix(in srgb, var(--away) 85%, white);
}

</style>
</head>
<body>
<div id="root" class="wrap hidden">
  <div id="title" class="title">Racha</div>
  <div id="balls" class="balls"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  const p=new URLSearchParams(location.search);
  const MATCH_ID = p.get('matchId') || 'test123';
  const MIN_RUN = Math.max(1, parseInt(p.get('min')||'3',10));
  const SCALE = Math.max(12, parseInt(p.get('scale')||'18',10));
  const HOME_COLOR = p.get('homeColor');
  const AWAY_COLOR = p.get('awayColor');
  document.documentElement.style.setProperty('--scale', SCALE);
  if (HOME_COLOR) document.documentElement.style.setProperty('--home', HOME_COLOR);
  if (AWAY_COLOR) document.documentElement.style.setProperty('--away', AWAY_COLOR);

  const firebaseConfig = {
    apiKey: "AIzaSyA4gVcq3UerKAHcmarEPlvkVp-iS7jvDaQ",
    authDomain: "supervolei-panel-final.firebaseapp.com",
    databaseURL: "https://supervolei-panel-final-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "supervolei-panel-final",
    storageBucket: "supervolei-panel-final.firebasestorage.app",
    messagingSenderId: "993690944196",
    appId: "1:993690944196:web:1a7ea451c03201e6f6ff91"
  };
  initializeApp(firebaseConfig);
  await signInAnonymously(getAuth());
  const db = getDatabase();

  const root = document.getElementById('root');
  const titleEl = document.getElementById('title');
  const ballsEl = document.getElementById('balls');

  // Team names
  let teamHome = 'HOME', teamAway = 'AWAY';
  onValue(ref(db, `matches/${MATCH_ID}/teams`), s=>{
    const v = s.val() || {};
    teamHome = v.home || 'HOME';
    teamAway = v.away || 'AWAY';
  });

  // Streak state
  let currentSet = 1;
  let lastHome = 0, lastAway = 0;
  let streakTeam = null;
  let streakCount = 0;

  function resetStreak(){
    streakTeam = null;
    streakCount = 0;
    root.classList.add('hidden');
    root.classList.remove('home','away');
    titleEl.textContent = 'Racha';
    ballsEl.innerHTML='';
  }

  function renderStreak(){
    if (streakCount >= MIN_RUN){
      root.classList.remove('hidden');
      root.classList.toggle('home', streakTeam==='home');
      root.classList.toggle('away', streakTeam==='away');
      const name = streakTeam==='home' ? teamHome : teamAway;
      titleEl.textContent = `Racha 路 ${name}`;
      ballsEl.innerHTML = "";
      for(let i=0;i<streakCount;i++){
        const span = document.createElement('span');
        span.className = 'ball';
        span.textContent = '';
        ballsEl.appendChild(span);
      }
    } else {
      root.classList.add('hidden');
      root.classList.remove('home','away');
      titleEl.textContent = 'Racha';
      ballsEl.innerHTML='';
    }
  }

  function handleScoreChange(newH, newA){
    const dH = newH - lastHome;
    const dA = newA - lastAway;
    if ((dH!==0 && dA!==0) || Math.abs(dH)>1 || Math.abs(dA)>1){
      resetStreak(); return;
    }
    if (dH===0 && dA===0) return;
    const scorer = dH===1 ? 'home' : (dA===1 ? 'away' : null);
    if (!scorer){ resetStreak(); return; }
    if (streakTeam === scorer){ streakCount += 1; } else { streakTeam = scorer; streakCount = 1; }
    renderStreak();
  }

  // === Rebinding de listeners por set ===
  let unsubs = []; // guardamos funciones de desuscripci贸n
  async function bindSetListeners(setNo){
    // Desuscribir anteriores
    unsubs.forEach(u=>{ try{ u&&u(); }catch(_){} });
    unsubs = [];

    // Inicializamos baseline para evitar falsos triggers al enganchar
    try{
      const snap = await get(child(ref(db), `matches/${MATCH_ID}/sets/${setNo}`));
      const node = snap.val() || {home:0, away:0};
      lastHome = parseInt(node.home||0,10);
      lastAway = parseInt(node.away||0,10);
    }catch{ lastHome=0; lastAway=0; }

    // Suscribir a home/away del set activo
    const u1 = onValue(ref(db, `matches/${MATCH_ID}/sets/${setNo}/home`), s=>{
      const v = parseInt(s.val()||0,10);
      handleScoreChange(v, lastAway);
      lastHome = v;
    });
    const u2 = onValue(ref(db, `matches/${MATCH_ID}/sets/${setNo}/away`), s=>{
      const v = parseInt(s.val()||0,10);
      handleScoreChange(lastHome, v);
      lastAway = v;
    });
    unsubs.push(u1, u2);
  }

  // Cambios de setNumber -> rebind + reset racha
  onValue(ref(db, `matches/${MATCH_ID}/heat/setNumber`), async snap=>{
    const n = parseInt(snap.val()||1,10);
    if (!Number.isNaN(n) && n!==currentSet){
      currentSet = n;
      resetStreak();
      await bindSetListeners(currentSet);
    }
  });

  // Tambi茅n, si cambia el 谩rbol completo de sets, refrescamos baseline
  onValue(ref(db, `matches/${MATCH_ID}/sets`), s=>{
    const all = s.val()||{};
    const node = all[currentSet] || {home:0, away:0};
    lastHome = parseInt(node.home||0,10);
    lastAway = parseInt(node.away||0,10);
  });

  // Inicio
  await bindSetListeners(currentSet);
</script>
</body>
</html>
