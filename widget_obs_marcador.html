<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OBS Marcador Vóley Vivo</title>
<style>
  html,body{margin:0;padding:0;background:transparent}
  :root{
    --scale:16;
    --fg:#ffffff;
    --sub:#fffae5;
    --row1:rgba(255,102,0,0.65);     /* naranja vivo */
    --row2:rgba(0,128,255,0.65);     /* azul vivo */
    --border:#ffffff;                /* separador blanco */
    --badge:rgba(255,255,255,.25);
    --badge-bd:rgba(255,255,255,.6);
    --radius:10px;
    --gap:6px;
    --padY: calc(var(--scale)*0.25px);
    --padX: calc(var(--scale)*0.35px);
  }
  .wrap{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--fg);font-size:calc(var(--scale)*1px);line-height:1.1;display:inline-block}
  .head,.table{display:grid;gap:var(--gap)}
  .row{display:grid;align-items:center;gap:var(--gap);padding:var(--padY) var(--padX);border-radius:var(--radius);backdrop-filter:blur(2px)}
  .row:nth-child(odd){background:var(--row1)}
  .row:nth-child(even){background:var(--row2)}
  .cell{display:flex;align-items:center;justify-content:center;white-space:nowrap;min-width:calc(var(--scale)*1.6px)}
  .team{justify-content:flex-start;font-weight:800;overflow:hidden;text-overflow:ellipsis}
  .team-pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);border:1px solid var(--badge-bd)}
  .score{font-weight:900;font-variant-numeric:tabular-nums}
  .head .cell{color:var(--sub);text-transform:uppercase;font-weight:700;letter-spacing:.4px;padding:2px 0}
  .divider-h{border-left:3px solid var(--border);padding-left:calc(var(--padX))}
  .divider-b{border-left:3px solid var(--border)}
  .shadow-on *{text-shadow:0 2px 3px rgba(0,0,0,.55),0 0 12px rgba(0,0,0,.4)}
</style>
</head>
<body>
<div id="root" class="wrap">
  <div id="head" class="head"></div>
  <div id="table" class="table"></div>
</div>
<script>
(function(){
  const p=new URLSearchParams(location.search);
  const API=p.get('api')||'';
  const TOKEN=p.get('token')||'';
  const COLS=Math.min(5,Math.max(1,parseInt(p.get('cols')||'5',10)));
  const SCALE=Math.max(12,parseInt(p.get('scale')||'16',10));
  const SHOW_TOTALS=p.get('totals')==='1';
  const SHADOW=p.get('shadow')==='1';

  document.documentElement.style.setProperty('--scale',SCALE);
  if(SHADOW)document.getElementById('root').classList.add('shadow-on');

  const $=s=>document.querySelector(s);
  const headEl=$('#head'), tableEl=$('#table');

  // plantilla de columnas dinámica
  const gridTemplate = cols => `minmax(${SCALE*7}px,1fr)` + ' auto'.repeat(cols) + (SHOW_TOTALS?' auto':'');

  function buildHead(cols){
    headEl.innerHTML='';
    headEl.style.gridTemplateColumns=gridTemplate(cols);

    // celda del nombre de equipo (vacía)
    const e=document.createElement('div'); e.className='cell'; headEl.appendChild(e);

    // S 1..cols
    for(let i=1;i<=cols;i++){
      const c=document.createElement('div');
      c.className='cell';
      c.textContent=`S ${i}`;
      headEl.appendChild(c);
    }
    // SETS
    if(SHOW_TOTALS){
      const c=document.createElement('div');
      c.className='cell divider-h';
      c.textContent='SETS';
      headEl.appendChild(c);
    }
  }

  function buildRow(label, cols){
    const r=document.createElement('div');
    r.className='row';
    r.style.gridTemplateColumns=gridTemplate(cols);

    const t=document.createElement('div');
    t.className='cell team';
    t.innerHTML=`<span class="team-pill">${label}</span>`;
    r.appendChild(t);

    for(let i=0;i<cols;i++){
      const c=document.createElement('div');
      c.className='cell score';
      c.textContent='—';
      r.appendChild(c);
    }

    if(SHOW_TOTALS){
      const ct=document.createElement('div');
      ct.className='cell score divider-b';
      ct.textContent='0';
      r.appendChild(ct);
    }
    return r;
  }

  // calcula cuántas columnas de set mostrar: desde S1 hasta el primero que esté 0-0
  function calcVisibleCols(hist){
    let visible=0;
    for(let i=0;i<COLS;i++){
      const r=hist[i]||{};
      const ph=Number(r.points_home||0);
      const pa=Number(r.points_away||0);
      if (ph===0 && pa===0) break;   // al primer 0-0, paramos
      visible = i+1;
    }
    return visible;
  }

  function render(names, hist){
    const cols = calcVisibleCols(hist);

    // reconstruye cabecera y filas con el nº de columnas visible
    headEl.innerHTML=''; tableEl.innerHTML='';
    buildHead(cols);
    const rowH=buildRow(names.home, cols);
    const rowA=buildRow(names.away, cols);
    tableEl.appendChild(rowH); tableEl.appendChild(rowA);

    // rellenar puntos de sets visibles
    for(let i=0;i<cols;i++){
      const r=hist[i]||{};
      const ph=Number(r.points_home||0);
      const pa=Number(r.points_away||0);
      rowH.children[1+i].textContent = String(ph);
      rowA.children[1+i].textContent = String(pa);
    }

    // totales (solo contando los sets visibles)
    if(SHOW_TOTALS){
      let th=0, ta=0;
      for(let i=0;i<cols;i++){
        const r=hist[i]||{};
        const ph=Number(r.points_home||0);
        const pa=Number(r.points_away||0);
        if (ph>pa) th++; else if (pa>ph) ta++;
      }
      // última celda de cada fila
      rowH.lastChild.textContent = String(th);
      rowA.lastChild.textContent = String(ta);
    }
  }

  // ======== Fetch & refresh ========
  let lastSnap='';
  async function fetchData(){
    if(!API) return;
    try{
      const qsBase = API + (API.includes('?')?'&':'?') + (TOKEN?('token='+encodeURIComponent(TOKEN)+'&'):'') + 't=' + Date.now();
      const [rS, rH] = await Promise.all([
        fetch(qsBase, {cache:'no-store'}),
        fetch(API + (API.includes('?')?'&':'?') + (TOKEN?('token='+encodeURIComponent(TOKEN)+'&'):'') + 'type=history&t=' + Date.now(), {cache:'no-store'})
      ]);

      const js=await rS.json().catch(()=>({}));
      const jh=await rH.json().catch(()=>({history:[]}));

      const d=js.data||js||{};
      const hist=Array.isArray(jh.history)?jh.history:[];

      const names = { home:String(d.team_home||'HOME'), away:String(d.team_away||'AWAY') };

      // snapshot para evitar repintados innecesarios
      const vis = calcVisibleCols(hist);
      const snap = JSON.stringify({
        names,
        vis,
        h: hist.slice(0,vis).map(r=>({ph:r.points_home, pa:r.points_away}))
      });

      if (snap !== lastSnap){
        lastSnap = snap;
        render(names, hist);
      }
    }catch(_){ /* silencioso en OBS */ }
  }

  function loop(){ fetchData().finally(()=>setTimeout(loop,1500)); }

  // primer render base
  buildHead(0);
  tableEl.appendChild(buildRow('HOME',0));
  tableEl.appendChild(buildRow('AWAY',0));

  loop();
})();
</script>
</body>
</html>



