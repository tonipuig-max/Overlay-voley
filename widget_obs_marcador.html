<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OBS Marcador Vóley (rápido)</title>
<style>
  html,body{margin:0;padding:0;background:transparent}
  :root{
    --scale:16;
    --fg:#ffffff;
    --sub:#fffae5;
    --row1:rgba(255,102,0,0.65);
    --row2:rgba(0,128,255,0.65);
    --border:#ffffff;
    --badge:rgba(255,255,255,.25);
    --badge-bd:rgba(255,255,255,.6);
    --radius:10px;
    --gap:6px;
    --padY: calc(var(--scale)*0.25px);
    --padX: calc(var(--scale)*0.35px);
  }
  .wrap{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--fg);font-size:calc(var(--scale)*1px);line-height:1.1;display:inline-block}
  .head,.table{display:grid;gap:var(--gap)}
  .row{display:grid;align-items:center;gap:var(--gap);padding:var(--padY) var(--padX);border-radius:var(--radius);backdrop-filter:blur(2px)}
  .row:nth-child(odd){background:var(--row1)}
  .row:nth-child(even){background:var(--row2)}
  .cell{display:flex;align-items:center;justify-content:center;white-space:nowrap;min-width:calc(var(--scale)*1.6px)}
  .team{justify-content:flex-start;font-weight:800;overflow:hidden;text-overflow:ellipsis}
  .team-pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);border:1px solid var(--badge-bd)}
  .score{font-weight:900;font-variant-numeric:tabular-nums}
  .head .cell{color:var(--sub);text-transform:uppercase;font-weight:700;letter-spacing:.4px;padding:2px 0}
  .divider-h{border-left:3px solid var(--border);padding-left:calc(var(--padX))}
  .divider-b{border-left:3px solid var(--border)}
  .shadow-on *{text-shadow:0 2px 3px rgba(0,0,0,.55),0 0 12px rgba(0,0,0,.4)}
</style>
</head>
<body>
<div id="root" class="wrap">
  <div id="head" class="head"></div>
  <div id="table" class="table"></div>
</div>
<script>
(function(){
  const p=new URLSearchParams(location.search);
  const API=p.get('api')||'';
  const TOKEN=p.get('token')||'';
  const COLS=Math.min(5,Math.max(1,parseInt(p.get('cols')||'5',10)));
  const SCALE=Math.max(12,parseInt(p.get('scale')||'16',10));
  const SHOW_TOTALS=p.get('totals')==='1';
  const SHADOW=p.get('shadow')==='1';
  const INTERVAL=Math.max(150, parseInt(p.get('interval')||'500',10) || 500); // mínimo 150ms por seguridad

  document.documentElement.style.setProperty('--scale',SCALE);
  if(SHADOW)document.getElementById('root').classList.add('shadow-on');

  const $=s=>document.querySelector(s);
  const headEl=$('#head'), tableEl=$('#table');

  // plantilla de columnas dinámica
  const gridTemplate = cols => `minmax(${SCALE*7}px,1fr)` + ' auto'.repeat(cols) + (SHOW_TOTALS?' auto':'');

  function buildHead(cols){
    headEl.innerHTML='';
    headEl.style.gridTemplateColumns=gridTemplate(cols);
    const e=document.createElement('div'); e.className='cell'; headEl.appendChild(e);
    for(let i=1;i<=cols;i++){const c=document.createElement('div'); c.className='cell'; c.textContent=`S ${i}`; headEl.appendChild(c);}
    if(SHOW_TOTALS){const c=document.createElement('div'); c.className='cell divider-h'; c.textContent='SETS'; headEl.appendChild(c);}
  }

  function buildRow(label, cols){
    const r=document.createElement('div');
    r.className='row';
    r.style.gridTemplateColumns=gridTemplate(cols);
    const t=document.createElement('div'); t.className='cell team'; t.innerHTML=`<span class="team-pill">${label}</span>`; r.appendChild(t);
    for(let i=0;i<cols;i++){const c=document.createElement('div'); c.className='cell score'; c.textContent='—'; r.appendChild(c);}
    if(SHOW_TOTALS){const ct=document.createElement('div'); ct.className='cell score divider-b'; ct.textContent='0'; r.appendChild(ct);}
    return r;
  }

  function calcVisibleCols(hist){
    let visible=0;
    for(let i=0;i<COLS;i++){
      const r=hist[i]||{};
      const ph=Number(r.points_home||0);
      const pa=Number(r.points_away||0);
      if (ph===0 && pa===0) break;
      visible = i+1;
    }
    return Math.max(visible,1); // al menos 1 columna para estabilidad visual
  }

  function render(names, hist){
    const cols = calcVisibleCols(hist);
    headEl.innerHTML=''; tableEl.innerHTML='';
    buildHead(cols);
    const rowH=buildRow(names.home, cols);
    const rowA=buildRow(names.away, cols);
    tableEl.appendChild(rowH); tableEl.appendChild(rowA);
    for(let i=0;i<cols;i++){
      const r=hist[i]||{};
      const ph=Number(r.points_home||0);
      const pa=Number(r.points_away||0);
      rowH.children[1+i].textContent = String(ph);
      rowA.children[1+i].textContent = String(pa);
    }
    if(SHOW_TOTALS){
      let th=0, ta=0;
      for(let i=0;i<cols;i++){
        const r=hist[i]||{};
        const ph=Number(r.points_home||0);
        const pa=Number(r.points_away||0);
        if (ph>pa) th++; else if (pa>ph) ta++;
      }
      rowH.lastChild.textContent = String(th);
      rowA.lastChild.textContent = String(ta);
    }
  }

  // ======== Fetch optimizado ========
  let lastSnap='';
  let inFlight; // AbortController para cancelar si hay nueva iteración

  function buildQS(base, extra=''){
    const sep = base.includes('?') ? '&' : '?';
    const tok = TOKEN ? ('token='+encodeURIComponent(TOKEN)+'&') : '';
    return base + sep + tok + extra + (extra ? '&' : '') + 't=' + Date.now();
  }

  async function fetchBundled(ctrl){
    const r = await fetch(buildQS(API, 'bundle=1'), {cache:'no-store', signal: ctrl.signal});
    const j = await r.json();
    // esperamos formato { data: {...}, history: [...] }
    const d = j.data || {};
    const hist = Array.isArray(j.history) ? j.history : [];
    return { d, hist };
  }

  async function fetchSplit(ctrl){
    const [rS, rH] = await Promise.all([
      fetch(buildQS(API,''), {cache:'no-store', signal: ctrl.signal}),
      fetch(buildQS(API,'type=history'), {cache:'no-store', signal: ctrl.signal})
    ]);
    const js = await rS.json().catch(()=>({}));
    const jh = await rH.json().catch(()=>({history:[]}));
    const d = js.data || js || {};
    const hist = Array.isArray(jh.history) ? jh.history : [];
    return { d, hist };
  }

  async function fetchData(){
    if(!API) return;
    if(inFlight){ try{ inFlight.abort(); }catch(_){ } }
    inFlight = new AbortController();
    const ctrl = inFlight;

    try{
      // 1) Intentar endpoint combinado
      let d, hist;
      try{
        ({ d, hist } = await fetchBundled(ctrl));
      }catch(_){
        // 2) Fallback a dos peticiones en paralelo
        ({ d, hist } = await fetchSplit(ctrl));
      }

      const names = { home:String(d.team_home||'HOME'), away:String(d.team_away||'AWAY') };
      const vis = calcVisibleCols(hist);
      const snap = JSON.stringify({
        names,
        vis,
        h: hist.slice(0,vis).map(r=>({ph:r.points_home, pa:r.points_away}))
      });

      if (snap !== lastSnap){
        lastSnap = snap;
        // usar rAF para pintar lo más cerca del siguiente frame
        requestAnimationFrame(()=>render(names, hist));
      }
    }catch(e){
      // Silencioso en OBS; si fue abortado, ignorar.
    }
  }

  function loop(){
    fetchData().finally(()=>setTimeout(loop, INTERVAL));
  }

  // Render inicial
  (function firstPaint(){
    headEl.innerHTML=''; tableEl.innerHTML='';
    buildHead(1);
    tableEl.appendChild(buildRow('HOME',1));
    tableEl.appendChild(buildRow('AWAY',1));
  })();

  loop();
})();
</script>
</body>
</html>




