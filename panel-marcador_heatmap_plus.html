<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Panel Marcador V√≥ley</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#f7f8fa;
    --muted:#e3e7ee;
    --text:#1f2937;
    --sub:#6b7280;
    --accent:#2563eb;
    --ok:#16a34a;
    --warn:#f59e0b;
    --danger:#dc2626;
    --radius:14px;
    --input:#ffffff;
    --input-border:#d1d5db;
    --btn:#eef2f7;
    --btn-border:#cbd5e1;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px 16px 88px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:var(--radius);padding:14px;margin-bottom:14px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px;color:var(--sub)}
  label{font-size:13px;color:var(--sub)}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input);color:var(--text)}
  .row{display:flex;gap:10px;align-items:center}
  .grid{display:grid;gap:10px}
  .grid2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px;
       width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--btn-border);
       background:var(--btn);color:var(--text);font-weight:700;font-size:16px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-ok   { background:#e9f7ee; border-color:#bfe8ca; color:#0f5132 }
  .btn-accent{ background:#e8efff; border-color:#c7d5ff; color:#1e40af }
  .scoreInput{width:64px;text-align:center;font-size:28px;font-weight:900;padding:6px 8px;border-radius:10px;background:#fff;border:1px solid var(--input-border);color:var(--text)}
  .badge-set{
    min-width:48px;
    text-align:center;
    border:1px solid var(--muted);
    border-radius:8px;
    padding:4px 6px;
    background:#fff;
    color:var(--text);
    white-space:nowrap; /* üîë evita que se parta ‚ÄúS‚Äù y el n√∫mero */
  }
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:8px}
  th{color:var(--sub);font-weight:600;border-bottom:1px solid var(--muted)}
  .cell{display:flex;align-items:center;justify-content:center;gap:6px}
  .thName{max-width:160px; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;background:linear-gradient(to top, rgba(255,255,255,.95), rgba(255,255,255,.7), transparent);border-top:1px solid var(--muted)}
  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
  .dot.ok{background:var(--ok)}
  .small{font-size:12px;color:var(--sub)}

/* === Heatmap manual block === */
.heat-card h2{ margin-bottom:12px }
.heat-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.heat-set{ display:flex; align-items:center; gap:8px; }
.heat-set .scoreInput{ width:74px; }
.teamHeader{ font-weight:800; font-size:14px; margin:4px 0 8px; color:var(--text); }
.vstack{ display:flex; flex-direction:column; gap:8px; }
.btn-zone{ display:flex; justify-content:space-between; }
.btn-z1{ background:#e9f2ff; border-color:#c7dbff; color:#1e40af }
.btn-z2{ background:#eafcf3; border-color:#c5efd9; color:#065f46 }
.btn-z3{ background:#fff5e6; border-color:#ffe0b3; color:#92400e }

</style>
</head>
<body>
<div class="wrap">

  <!-- Nombres equipos -->
  <div class="card">
    <div class="grid grid2">
      <div><label>Equipo HOME</label><input id="nameHome" /></div>
      <div><label>Equipo AWAY</label><input id="nameAway" /></div>
    </div>
    <div class="small" style="margin-top:8px">Los nombres se guardan al validar (Enter) o salir del campo.</div>
  </div>

  <!-- Tabla puntos -->
  <div class="card">
    <h2>Puntos por set</h2>
    <table>
      <thead>
        <tr>
          <th style="width:82px">Set</th>
          <th><span id="thHome" class="thName">HOME</span></th>
          <th><span id="thAway" class="thName">AWAY</span></th>
        </tr>
      </thead>
      <tbody id="pointsBody"></tbody>
    </table>
  </div>

  <!-- Heatmap (manual) -->
  <div class="card heat-card">
    <h2>Heatmap (manual)</h2>

    <!-- Selector de set en juego -->
    <div class="heat-row" style="margin-bottom:10px">
      <div class="heat-set">
        <label>Set</label>
        <button class="btn" onclick="bumpHeatSet(-1)">‚àí</button>
        <input id="heatSet" class="scoreInput" value="1" readonly />
        <button class="btn btn-ok" onclick="bumpHeatSet(1)">+</button>
      </div>
      <div class="small">Este set es el que se usar√° para registrar los toques por zona.</div>
    </div>

    <div class="grid grid2">
      <!-- HOME -->
      <div>
        <div class="teamHeader" id="heatHomeName">HOME</div>
        <div class="vstack">
          <button class="btn btn-zone btn-z1" id="btn_home_z1" onclick="heatBump('home',1)">Zona 1 ‚Äî <span id="cnt_home_1">0</span></button>
          <button class="btn btn-zone btn-z2" id="btn_home_z2" onclick="heatBump('home',2)">Zona 2 ‚Äî <span id="cnt_home_2">0</span></button>
          <button class="btn btn-zone btn-z3" id="btn_home_z3" onclick="heatBump('home',3)">Zona 3 ‚Äî <span id="cnt_home_3">0</span></button>
        </div>
      </div>

      <!-- AWAY -->
      <div>
        <div class="teamHeader" id="heatAwayName">AWAY</div>
        <div class="vstack">
          <button class="btn btn-zone btn-z1" id="btn_away_z1" onclick="heatBump('away',1)">Zona 1 ‚Äî <span id="cnt_away_1">0</span></button>
          <button class="btn btn-zone btn-z2" id="btn_away_z2" onclick="heatBump('away',2)">Zona 2 ‚Äî <span id="cnt_away_2">0</span></button>
          <button class="btn btn-zone btn-z3" id="btn_away_z3" onclick="heatBump('away',3)">Zona 3 ‚Äî <span id="cnt_away_3">0</span></button>
        </div>
      </div>
    </div>

    <div class="small" style="margin-top:10px">
      Cada pulsaci√≥n env√≠a a <b>Heatmap</b>: <code>set</code>, <code>side</code>, <code>team</code>, <code>zone</code> y <code>count</code>/<code>delta</code>.
    </div>
  </div>

  <!-- Config (al final) -->
  <!-- Config (al final) -->
  <div class="card">
    <h1>Panel Marcador</h1>
    <div class="grid grid2">
      <div><label>URL API (/exec)</label><input id="api" placeholder="https://script.google.com/macros/s/.../exec"></div>
      <div><label>Token</label><input id="tok" placeholder="tu-token-seguro"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn btn-accent" onclick="saveCfg()">Guardar</button>
      <button class="btn btn-ok" onclick="loadAll()">Refrescar</button>
    </div>
  </div>

</div>

<!-- Footer -->
<div class="footer">
  <div class="status">
    <div id="netdot" class="dot"></div>
    <div id="netmsg" class="small">Sin conexi√≥n</div>
    <div class="small" id="lastSync"></div>
  </div>
</div>

<script>
  // ===== Estado y funciones como antes =====
  let state = { team_home:'HOME', team_away:'AWAY', points_home:0, points_away:0, sets_home:0, sets_away:0, set_number:1 };
  let history = [];
  const $ = s => document.querySelector(s);
  function saveCfg(){ localStorage.setItem('api',$('#api').value.trim()); localStorage.setItem('tok',$('#tok').value.trim()); pulseNet('Config guardada', true); }
  function loadCfg(){ $('#api').value=localStorage.getItem('api')||''; $('#tok').value=localStorage.getItem('tok')||''; }
  function apiURL(){ const u=$('#api').value.trim(); if(!u) throw new Error('Configura la URL API'); return u; }
  function token(){ return $('#tok').value.trim(); }
  function pulseNet(msg, ok){ $('#netdot').classList.toggle('ok',!!ok); $('#netmsg').textContent=msg; $('#lastSync').textContent= ok ? ('Actualizado ¬∑ '+new Date().toLocaleTimeString()):''; }
  const truncate=(s,max=26)=> (s||'').length>max ? (s.slice(0,max-1)+'‚Ä¶') : (s||'');
  function setTeamHeaders(){ $('#thHome').textContent=truncate(state.team_home,26); $('#thAway').textContent=truncate(state.team_away,26); }
  function paintTable(){ const body=$('#pointsBody'); body.innerHTML=''; for(let i=0;i<5;i++){const setNo=i+1; const row=history[i]||{}; const ph=Number(row.points_home||0),pa=Number(row.points_away||0); const tr=document.createElement('tr'); tr.innerHTML=`<td><span class="badge-set">S ${setNo}</span></td>
<td><div class="cell"><button class="btn" onclick="bump(${setNo},'home',-1)">‚àí</button><input class="scoreInput" id="in_home_${setNo}" type="number" value="${ph}"><button class="btn btn-ok" onclick="bump(${setNo},'home',+1)">+</button></div></td>
<td><div class="cell"><button class="btn" onclick="bump(${setNo},'away',-1)">‚àí</button><input class="scoreInput" id="in_away_${setNo}" type="number" value="${pa}"><button class="btn btn-ok" onclick="bump(${setNo},'away',+1)">+</button></div></td>`; body.appendChild(tr);
const ih=document.getElementById(`in_home_${setNo}`),ia=document.getElementById(`in_away_${setNo}`);
ih.addEventListener('change',()=>setScoreManual(setNo,'home',ih.value)); ia.addEventListener('change',()=>setScoreManual(setNo,'away',ia.value));
ih.addEventListener('keydown',e=>{if(e.key==='Enter'){ih.blur();}}); ia.addEventListener('keydown',e=>{if(e.key==='Enter'){ia.blur();}});} }
  function renderAll(){ $('#nameHome').value=state.team_home; $('#nameAway').value=state.team_away; setTeamHeaders(); paintTable(); }
  async function loadAll(){ const url=apiURL(); const r1=await fetch(url+'?t='+Date.now()); const j1=await r1.json(); const d=j1.data||j1; state.team_home=d.team_home||'HOME'; state.team_away=d.team_away||'AWAY'; state.points_home=Number(d.points_home||0); state.points_away=Number(d.points_away||0); state.sets_home=Number(d.sets_home||0); state.sets_away=Number(d.sets_away||0); state.set_number=Number(d.set_number||1); const r2=await fetch(url+'?type=history&t='+Date.now()); const j2=await r2.json().catch(()=>({history:[]})); history=j2.history||[]; renderAll(); pulseNet('Conectado',true); }
  async function postPatch(patch){ const u=new URL(apiURL()); const tok=token().trim(); if(tok) u.searchParams.set('token',tok); const form=new URLSearchParams(); if(tok) form.append('token',tok); Object.keys(patch).forEach(k=>form.append(k,String(patch[k]))); form.append('json',JSON.stringify(patch)); const res=await fetch(u,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:form.toString()}); const json=await res.json(); if(json.data){state.team_home=json.data.team_home; state.team_away=json.data.team_away;} if(json.history) history=json.history; renderAll(); pulseNet('Guardado',true);}
  function bump(setNo,side,delta){const input=document.getElementById(`in_${side}_${setNo}`); const cur=Number(input.value||0); const next=Math.max(0,cur+delta); input.value=next; const action=delta>0?(side==='home'?'inc_home':'inc_away'):(side==='home'?'dec_home':'dec_away'); postPatch({action,set_target:setNo});}
  function setScoreManual(setNo,side,val){const v=Math.max(0,parseInt(val,10)||0); const payload={set_target:setNo}; if(side==='home') payload.points_home=v; else payload.points_away=v; postPatch(payload);}
  function autoSaveNames(){const th=$('#nameHome').value.trim(); const ta=$('#nameAway').value.trim(); if((th&&th!==state.team_home)||(ta&&ta!==state.team_away)){ if(th) state.team_home=th; if(ta) state.team_away=ta; setTeamHeaders(); postPatch({team_home:state.team_home, team_away:state.team_away});}}
  function bindNameAutosave(){const h=$('#nameHome'),a=$('#nameAway'); const handler=ev=>{if(ev.type==='keydown'&&ev.key!=='Enter')return; ev.target.blur(); autoSaveNames();}; h.addEventListener('keydown',handler); a.addEventListener('keydown',handler); h.addEventListener('blur',()=>autoSaveNames()); a.addEventListener('blur',()=>autoSaveNames());}
  loadCfg(); bindNameAutosave(); loadAll();
</script>

<script>
// ===== Heatmap manual (cliente) =====
(function(){
  const HEAT_SHEET = 'Heatmap'; // H may√∫scula
  const $ = (sel)=>document.querySelector(sel);

  // Estado local
  window.heat = window.heat || { sets:{} }; // sets[setNo] = {home:[c1,c2,c3], away:[c1,c2,c3]}

  function heatEnsureSet(setNo){
    if(!heat.sets[setNo]) heat.sets[setNo] = { home:[0,0,0], away:[0,0,0] };
  }

  window.heatRender = function heatRender(){
    const s = (window.state && window.state.set_number) || 1;
    heatEnsureSet(s);
    const H = heat.sets[s];
    if ($('#heatSet')) $('#heatSet').value = s;
    if ($('#heatHomeName')) $('#heatHomeName').textContent = (window.state && state.team_home) || 'HOME';
    if ($('#heatAwayName')) $('#heatAwayName').textContent = (window.state && state.team_away) || 'AWAY';
    for(let z=1; z<=3; z++){
      if ($('#cnt_home_'+z)) $('#cnt_home_'+z).textContent = H.home[z-1]||0;
      if ($('#cnt_away_'+z)) $('#cnt_away_'+z).textContent = H.away[z-1]||0;
    }
  };

  window.loadHeatmapSet = async function loadHeatmapSet(setNo){
    try{
      const url = apiURL() + '?type=heatmap&sheet=' + encodeURIComponent(HEAT_SHEET) + '&set=' + setNo + '&t=' + Date.now();
      const r = await fetch(url, {method:'GET'});
      const j = await r.json();
      const H = { home:[0,0,0], away:[0,0,0] };
      let rows = [];
      if (Array.isArray(j)) rows = j;
      else if (Array.isArray(j.rows)) rows = j.rows;
      else if (Array.isArray(j.data)) rows = j.data;
      else if (j && j.data && Array.isArray(j.data.rows)) rows = j.data.rows;
      else if (j && j.heatmap && Array.isArray(j.heatmap)) rows = j.heatmap;
      rows.forEach(row => {
        const side = (String(row.side||'').toLowerCase()==='away')?'away':'home';
        const z = Number(row.zone || row.area || row.z || 0);
        const c = Number(row.count || row.value || row.total || row.c || 0);
        if(z>=1 && z<=3){ H[side][z-1] = c; }
      });
      heat.sets[setNo] = H;
      heatRender();
    }catch(e){
      heatEnsureSet(setNo);
      heatRender();
    }
  };

  async function heatSeedIfMissing(setNo){
    const home = (window.state && state.team_home) || 'HOME';
    const away = (window.state && state.team_away) || 'AWAY';
    for(let z=1; z<=3; z++){
      try{ await postPatch({ action:'heat_set', type:'heatmap', sheet:HEAT_SHEET, set:setNo, side:'home', team:home, zone:z, count:0 }); }catch(_){}
      try{ await postPatch({ action:'heat_set', type:'heatmap', sheet:HEAT_SHEET, set:setNo, side:'away', team:away, zone:z, count:0 }); }catch(_){}
    }
  }

  window.bumpHeatSet = function bumpHeatSet(delta){
    const current = (window.state && state.set_number) || 1;
    const next = Math.max(1, Math.min(5, Number(current) + delta));
    if (!window.state) window.state = {};
    if(next === state.set_number) return;
    state.set_number = next;
    if ($('#heatSet')) $('#heatSet').value = next;
    // Persistir set en backend si existe endpoint
    if (typeof postPatch === 'function'){
      try{ postPatch({ set_number: next }); }catch(_){}
    }
    // Asegurar filas y cargar
    heatSeedIfMissing(next).then(()=>loadHeatmapSet(next));
    // Refrescar
    if (typeof window.renderAll === 'function') window.renderAll();
    heatRender();
  };

  window.heatBump = async function heatBump(side, zone){
    const setNo = (window.state && state.set_number) || 1;
    heatEnsureSet(setNo);
    const arr = heat.sets[setNo][side];
    arr[zone-1] = (arr[zone-1]||0) + 1; // optimista
    heatRender();

    // 1) Intento heat_set (valor absoluto)
    const countNow = arr[zone-1];
    const payloadSet = {
      action:'heat_set', type:'heatmap', sheet:HEAT_SHEET,
      set:setNo, side:side, team: (side==='home' ? ((state&&state.team_home)||'HOME') : ((state&&state.team_away)||'AWAY')),
      zone:zone, count:countNow
    };
    try{
      if (typeof postPatch === 'function'){
        await postPatch(payloadSet);
        await loadHeatmapSet(setNo);
        return;
      }
    }catch(e){ /* fallback abajo */ }

    // 2) Fallback heat_bump (delta)
    const payloadBump = {
      action:'heat_bump', type:'heatmap', sheet:HEAT_SHEET,
      set:setNo, side:side, team: (side==='home' ? ((state&&state.team_home)||'HOME') : ((state&&state.team_away)||'AWAY')),
      zone:zone, delta:1
    };
    try{
      if (typeof postPatch === 'function'){
        await postPatch(payloadBump);
        await loadHeatmapSet(setNo);
      }
    }catch(e2){
      console.error('heat_bump failed', e2);
    }
  };

  // Integraci√≥n suave con el panel original
  const prevRenderAll = window.renderAll;
  window.renderAll = function(){
    try{ if (typeof prevRenderAll === 'function') prevRenderAll(); }catch(_){}
    try{ heatRender(); }catch(_){}
  };

  window.addEventListener('DOMContentLoaded', function(){
    // Cargar heatmap del set inicial con un peque√±o retardo, para dejar cargar config
    setTimeout(()=>{
      try{ loadHeatmapSet((window.state && state.set_number) || 1); }catch(_){}
    }, 500);
  });
})();
</script>

</body>
</html>






