<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Panel Marcador Vóley</title>
<style>
  :root{
    --bg:#0b0e12; --card:#141821; --muted:#2a3040; --text:#e9eef7; --sub:#a7b0c2;
    --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --radius:14px;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px 16px 88px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:var(--radius);padding:14px;margin-bottom:14px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px;color:var(--sub)}
  label{font-size:13px;color:var(--sub)}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--muted);background:#0f1320;color:var(--text)}
  .row{display:flex;gap:10px;align-items:center}
  .grid{display:grid;gap:10px}
  .grid2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px;
       width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--muted);background:#1f2433;color:var(--text);
       font-weight:700;font-size:16px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn-ok{background:#133229;border-color:#1d6c4f}
  .scoreInput{width:64px;text-align:center;font-size:28px;font-weight:900;padding:6px 8px;border-radius:10px;background:#0f1320;border:1px solid var(--muted);color:var(--text)}
  .badge-set{min-width:48px;text-align:center;border:1px solid var(--muted);border-radius:8px;padding:4px 6px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:8px}
  th{color:var(--sub);font-weight:600}
  .cell{display:flex;align-items:center;justify-content:center;gap:6px}
  .thName{max-width:140px; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:10px 16px;background:linear-gradient(to top, rgba(11,14,18,.95), rgba(11,14,18,.6), transparent)}
  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
  .dot.ok{background:var(--ok)}
  .small{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Config -->
  <div class="card">
    <h1>Panel Marcador</h1>
    <div class="grid grid2">
      <div><label>URL API (/exec)</label><input id="api" placeholder="https://script.google.com/macros/s/.../exec"></div>
      <div><label>Token</label><input id="tok" placeholder="tu-token-seguro"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveCfg()">Guardar</button>
      <button class="btn btn-ok" onclick="loadAll()">Refrescar</button>
    </div>
  </div>

  <!-- Nombres equipos (autosave) -->
  <div class="card">
    <div class="grid grid2">
      <div><label>Equipo HOME</label><input id="nameHome" /></div>
      <div><label>Equipo AWAY</label><input id="nameAway" /></div>
    </div>
    <div class="small" style="margin-top:8px">Los nombres se guardan automáticamente al validar (Enter) o salir del campo.</div>
  </div>

  <!-- Tabla puntos 5x2 -->
  <div class="card">
    <h2>Puntos por set</h2>
    <table>
      <thead>
        <tr>
          <th style="width:82px">Set</th>
          <th><span id="thHome" class="thName">HOME</span></th>
          <th><span id="thAway" class="thName">AWAY</span></th>
        </tr>
      </thead>
      <tbody id="pointsBody"></tbody>
    </table>
  </div>
</div>

<!-- Footer estado -->
<div class="footer">
  <div class="status">
    <div id="netdot" class="dot"></div>
    <div id="netmsg" class="small">Sin conexión</div>
    <div class="small" id="lastSync"></div>
  </div>
</div>

<script>
  // ===== Estado =====
  let state = { team_home:'HOME', team_away:'AWAY', points_home:0, points_away:0, sets_home:0, sets_away:0, set_number:1 };
  let history = []; // 5 filas
  let inFlight=false;

  // ===== Utils =====
  const $ = s => document.querySelector(s);
  function saveCfg(){ localStorage.setItem('api', $('#api').value.trim()); localStorage.setItem('tok', $('#tok').value.trim()); pulseNet('Config guardada', true); }
  function loadCfg(){ $('#api').value = localStorage.getItem('api') || ''; $('#tok').value = localStorage.getItem('tok') || ''; }
  function apiURL(){ const u=$('#api').value.trim(); if(!u) throw new Error('Configura la URL API'); return u; }
  function token(){ return $('#tok').value.trim(); }
  function pulseNet(msg, ok){ $('#netdot').classList.toggle('ok', !!ok); $('#netmsg').textContent = msg; $('#lastSync').textContent = ok ? ('Actualizado · ' + new Date().toLocaleTimeString()) : ''; }

  const truncate = (s,max=26)=> (s||'').length>max ? (s.slice(0,max-1)+'…') : (s||'');

  function setTeamHeaders(){
    $('#thHome').textContent = truncate(state.team_home, 26);
    $('#thAway').textContent = truncate(state.team_away, 26);
  }

  // ===== Pintado =====
  function paintTable(){
    const body = $('#pointsBody');
    body.innerHTML = '';
    for (let i=0;i<5;i++){
      const setNo = i+1;
      const row = history[i] || {};
      const ph = Number(row.points_home || 0);
      const pa = Number(row.points_away || 0);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge-set">S ${setNo}</span></td>
        <td>
          <div class="cell">
            <button class="btn" onclick="bump(${setNo}, 'home', -1)">−</button>
            <input class="scoreInput" id="in_home_${setNo}" type="number" min="0" step="1" value="${ph}">
            <button class="btn btn-ok" onclick="bump(${setNo}, 'home', +1)">+</button>
          </div>
        </td>
        <td>
          <div class="cell">
            <button class="btn" onclick="bump(${setNo}, 'away', -1)">−</button>
            <input class="scoreInput" id="in_away_${setNo}" type="number" min="0" step="1" value="${pa}">
            <button class="btn btn-ok" onclick="bump(${setNo}, 'away', +1)">+</button>
          </div>
        </td>
      `;
      body.appendChild(tr);

      // Editar manual (on change o Enter)
      const ih = document.getElementById(`in_home_${setNo}`);
      const ia = document.getElementById(`in_away_${setNo}`);
      ih.addEventListener('change', ()=> setScoreManual(setNo, 'home', ih.value));
      ia.addEventListener('change', ()=> setScoreManual(setNo, 'away', ia.value));
      ih.addEventListener('keydown', e=>{ if (e.key==='Enter') { ih.blur(); }});
      ia.addEventListener('keydown', e=>{ if (e.key==='Enter') { ia.blur(); }});
    }
  }

  function renderAll(){
    $('#nameHome').value = state.team_home;
    $('#nameAway').value = state.team_away;
    setTeamHeaders();
    paintTable();
  }

  // ===== GET (solo bajo demanda) =====
  async function loadAll(){
    const url = apiURL();
    // Estado
    const r1 = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now(), { cache:'no-store' });
    if (!r1.ok){ console.error('GET state', r1.status, await r1.text()); pulseNet(`HTTP ${r1.status}`, false); return; }
    const j1 = await r1.json();
    const d = j1.data || j1;
    state = {
      team_home: d.team_home ?? 'HOME',
      team_away: d.team_away ?? 'AWAY',
      points_home: Number(d.points_home ?? 0),
      points_away: Number(d.points_away ?? 0),
      sets_home: Number(d.sets_home ?? 0),
      sets_away: Number(d.sets_away ?? 0),
      set_number: Number(d.set_number ?? 1)
    };
    // History
    const r2 = await fetch(url + (url.includes('?')?'&':'?') + 'type=history&t=' + Date.now(), { cache:'no-store' });
    if (!r2.ok){ console.error('GET history', r2.status, await r2.text()); }
    const j2 = await r2.json().catch(()=>({history:[]}));
    history = j2.history || [];
    renderAll();
    pulseNet('Conectado', true);
  }

  // ===== POST (sin rebote: solo pinto con respuesta del POST) =====
  async function postPatch(patch){
    const u = new URL(apiURL());
    const tok = token().trim();
    if (tok) u.searchParams.set('token', tok);

    const form = new URLSearchParams();
    if (tok) form.append('token', tok);
    Object.keys(patch).forEach(k => form.append(k, String(patch[k])));
    form.append('json', JSON.stringify(patch));

    inFlight = true;
    const res = await fetch(u, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: form.toString()
    });
    const text = await res.text().catch(()=> '');
    let json = null; try { json = text ? JSON.parse(text) : null; } catch(_){}
    inFlight = false;

    if (!res.ok || !json || json.ok === false) {
      console.error('POST error', res.status, text);
      pulseNet(`POST ${res.status}`, false);
      alert(`Error POST ${res.status}\n${text || '(sin cuerpo)'}`);
      return json || {};
    }

    // Pintar SOLO con la respuesta (evita flicker)
    if (json.data){
      const d = json.data;
      state = {
        team_home: d.team_home ?? state.team_home,
        team_away: d.team_away ?? state.team_away,
        points_home: Number(d.points_home ?? state.points_home),
        points_away: Number(d.points_away ?? state.points_away),
        sets_home: Number(d.sets_home ?? state.sets_home),
        sets_away: Number(d.sets_away ?? state.sets_away),
        set_number: Number(d.set_number ?? state.set_number)
      };
    }
    if (json.history){ history = json.history; }
    renderAll();
    pulseNet('Guardado', true);
    return json;
  }

  // ===== Acciones =====

  // + / − por set/equipo (pinto en el input y POST; sin GET)
  function bump(setNo, side, delta){
    const input = document.getElementById(`in_${side}_${setNo}`);
    const cur = Number(input.value || 0);
    const next = Math.max(0, cur + delta);
    input.value = next; // pinta ya
    const action = delta>0 ? (side==='home'?'inc_home':'inc_away') : (side==='home'?'dec_home':'dec_away');
    postPatch({ action, set_target: setNo });
  }

  // Edición manual
  function setScoreManual(setNo, side, val){
    const v = Math.max(0, parseInt(val, 10) || 0);
    const payload = { set_target: setNo };
    if (side==='home') payload.points_home = v; else payload.points_away = v;
    postPatch(payload);
  }

  // Autosave de nombres (Enter o blur)
  function autoSaveNames(){
    const th = $('#nameHome').value.trim();
    const ta = $('#nameAway').value.trim();
    const willChange = (th && th !== state.team_home) || (ta && ta !== state.team_away);
    if (!willChange) return;
    // Actualiza cabecera local para feedback inmediato
    if (th) state.team_home = th;
    if (ta) state.team_away = ta;
    setTeamHeaders();
    // Envía ambos para replicar 5 filas
    postPatch({ team_home: state.team_home, team_away: state.team_away });
  }

  // ===== Init =====
  function bindNameAutosave(){
    const h = $('#nameHome'), a = $('#nameAway');
    const handler = (ev)=>{ if (ev.type==='keydown' && ev.key!=='Enter') return; ev.target.blur(); autoSaveNames(); };
    h.addEventListener('keydown', handler);
    a.addEventListener('keydown', handler);
    h.addEventListener('blur', ()=>autoSaveNames());
    a.addEventListener('blur', ()=>autoSaveNames());
  }

  loadCfg();
  bindNameAutosave();
  loadAll();
</script>
</body>
</html>



