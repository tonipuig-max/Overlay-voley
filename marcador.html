<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Marcador FIVB Style · UNA SOLA LÍNEA · Firebase</title>
<style>
  /* Fondo transparente para OBS */
  html, body { margin:0; padding:0; background:transparent; height:100%; }
  :root{ --panel: rgba(18,22,28,.82); --accent: #e04662; --accent-d: #b2334a; --text: #f7fafc; }

  /* Contenedor centrado y SIN recortes */
  .wrap{ display:flex; align-items:center; justify-content:center; height:100%; overflow:visible; }

  /* >>> BARRA EN UNA ÚNICA LÍNEA <<< */
  .scorebar{
    display:flex; flex-wrap:nowrap; align-items:center; gap: 12px;
    padding: 10px 16px;
    background: var(--panel);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(2px);
    white-space:nowrap;
  }

  /* Posible escalado por URL (?scale=0.9) para caber en escenas estrechas */
  .scale { transform-origin:left center; }

  .team{ color: var(--text); font: 800 34px/1.05 Inter, system-ui, Arial; letter-spacing: .5px; min-width: 90px; text-align:left; }
  .team.right{ text-align:right; }

  .setsBox{ display:flex; flex-direction:column; align-items:center; justify-content:center; width:70px; flex:0 0 auto; }
  .setsLabel{ color:#ff7d93; text-transform:uppercase; font: 800 12px/1 Inter,system-ui,Arial; letter-spacing:.8px; }
  .setsValue{ margin-top:4px; min-width: 50px; text-align:center; color:#fff; background:#12161c; border-radius: 8px; padding: 8px 14px;
              font: 800 24px/1 Inter, system-ui, Arial; box-shadow: inset 0 0 0 2px rgba(255,255,255,.06); }

  .trap{ position:relative; width: 110px; height: 68px; flex:0 0 auto;
         background: linear-gradient(to bottom, var(--accent), var(--accent-d));
         clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
         display:flex; align-items:center; justify-content:center;
         box-shadow: 0 6px 22px rgba(224,70,98,.35); }
  .trap.right{ clip-path: polygon(0 0, 90% 0, 100% 100%, 10% 100%); }
  .trap .pts{ color:#fff; font: 900 40px/1 Inter, system-ui, Arial; text-shadow: 0 3px 8px rgba(0,0,0,.35); }

  .mid{ width: 38px; height: 58px; border-radius: 9px; background: linear-gradient(180deg, #10151b, #0b0f14);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; flex:0 0 auto; }
  .mid::before{ content:""; display:block; width: 10px; height: 36px; border-radius: 5px; background: linear-gradient(180deg, #e9edf1, #9aa5b1);
                mask: radial-gradient(6px 18px at 50% 35%, transparent 45%, black 46%), radial-gradient(7px 7px at 50% 75%, black 48%, transparent 49%); }

  .ring{ width: 10px; height: 72px; border-radius: 6px; background: linear-gradient(180deg,#ffdf54,#e4b301); flex:0 0 auto; }

  /* Evita que en pantallas pequeñas se rompa a 2 líneas.
     En su lugar, el usuario puede pasar ?scale=0.85 para encoger. */
  @media (max-width:900px){
    .team{ font-size:28px; min-width:72px; }
    .trap{ width: 92px; height: 58px; }
    .trap .pts{ font-size: 34px; }
    .setsBox{ width:60px; }
  }

  #dbg{ position:fixed; left:8px; bottom:8px; color:#a7f3d0; background:rgba(0,0,0,.75);
        border:1px solid #10b981; padding:8px 10px; border-radius:10px; display:none;
        font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
</style>
</head>
<body>
<div class="wrap">
  <div class="scorebar scale" id="bar">
    <div class="ring"></div>
    <div class="team" id="homeCode">HOME</div>
    <div class="setsBox"><div class="setsLabel">SETS</div><div class="setsValue" id="homeSets">0</div></div>
    <div class="trap"><div class="pts" id="homePts">0</div></div>
    <div class="mid"></div>
    <div class="trap right"><div class="pts" id="awayPts">0</div></div>
    <div class="setsBox"><div class="setsLabel">SETS</div><div class="setsValue" id="awaySets">0</div></div>
    <div class="team right" id="awayCode">AWY</div>
    <div class="ring"></div>
  </div>
</div>
<pre id="dbg"></pre>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const MATCH_ID = qs.get('matchId') || 'Ariadna2';
  const DEBUG = qs.get('debug') === '1';
  const SCALE = parseFloat(qs.get('scale')||'1');
  document.getElementById('bar').style.transform = `scale(${isFinite(SCALE)?SCALE:1})`;

  const dbg = document.getElementById('dbg');
  const log = (...a)=>{ if(DEBUG){ dbg.style.display='block'; dbg.textContent += a.join(' ')+'\\n'; }};

  const accent = qs.get('accent') || null;
  const accentD= qs.get('accentD')|| null;
  if (accent)  document.documentElement.style.setProperty('--accent',  accent);
  if (accentD) document.documentElement.style.setProperty('--accent-d',accentD);

  const code3 = (name, fallback) => {
    if(!name) return fallback || '---';
    const letters = (name.match(/[A-ZÁÉÍÓÚÜÑ]/gi) || []).join('').toUpperCase();
    return (letters.replaceAll('Ç','C').replaceAll('Ñ','N') || fallback || '---').slice(0,3);
  };

  const base = `matches/${MATCH_ID}`;
  const TEAMS = `${base}/teams`;
  const SETS  = `${base}/sets`;
  const WINS  = `${base}/setsWon`;
  const CURR  = [`${base}/ui/currentSet`, `${base}/setNumber`];

  const cfg = {
    apiKey: "AIzaSyA4gVcq3UerKAHcmarEPlvkVp-iS7jvDaQ",
    authDomain: "supervolei-panel-final.firebaseapp.com",
    databaseURL: "https://supervolei-panel-final-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "supervolei-panel-final",
    storageBucket: "supervolei-panel-final.firebasestorage.app",
    messagingSenderId: "993690944196",
    appId: "1:993690944196:web:1a7ea451c03201e6f6ff91"
  };
  firebase.initializeApp(cfg);
  firebase.auth().signInAnonymously().then(()=>{
    firebase.database().ref(TEAMS).on('value', s=>{
      const v=s.val()||{};
      document.getElementById('homeCode').textContent = code3(v.home,'HME');
      document.getElementById('awayCode').textContent = code3(v.away,'AWY');
      log('teams', JSON.stringify(v));
    });
    firebase.database().ref(WINS).on('value', s=>{
      const v=s.val()||{};
      document.getElementById('homeSets').textContent = Number(v.home||0);
      document.getElementById('awaySets').textContent = Number(v.away||0);
      log('wins', JSON.stringify(v));
    });

    let currentSetFb = 1; let displaySet = 1;
    CURR.forEach(p=>firebase.database().ref(p).on('value', s=>{
      const n = Number(s.val()||0);
      if(n) currentSetFb = Math.max(1, Math.min(5, n));
      pickDisplaySet(); updatePoints(); log('currSetFb', currentSetFb, 'from', p);
    }));

    let setsCache = {};
    firebase.database().ref(SETS).on('value', s=>{ setsCache = s.val()||{}; pickDisplaySet(); updatePoints(); log('sets', JSON.stringify(setsCache)); });

    function setFromCache(idx){ return setsCache[String(idx)] || setsCache[idx] || {}; }
    function hasPoints(node){ const h=Number(node.home||0)||0, a=Number(node.away||0)||0; return (h>0 || a>0); }
    function highestSetWithPoints(){ let hi=0; for(let i=1;i<=5;i++){ if(hasPoints(setFromCache(i))) hi=i; } return hi; }
    function pickDisplaySet(){
      // Si el siguiente set empieza a puntuar antes de que actualicen currentSet en Firebase,
      // avanzamos automáticamente para mostrarlo.
      const hi = highestSetWithPoints();
      if (hi >= currentSetFb) displaySet = hi || currentSetFb || 1;
      else displaySet = currentSetFb || hi || 1;
    }
    function updatePoints(){
      const node = setFromCache(displaySet);
      const hp = Number(node.home||0), ap = Number(node.away||0);
      document.getElementById('homePts').textContent = isFinite(hp)?hp:0;
      document.getElementById('awayPts').textContent = isFinite(ap)?ap:0;
    }
  });
})();
</script>
</body>
</html>